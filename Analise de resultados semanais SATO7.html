<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Performance Estratégica - Sato7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- CONFIGURAÇÕES GLOBAIS E VARIÁVEIS DE COR --- */
        :root {
            --bg-color: #0d1117;
            --card-color: #161b22;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --green: #238636;
            --green-light: #2ea043;
            --orange: #db6d28;
            --red: #da3633;
            --yellow: #f0b72f;
            --blue: #2f80ed;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
        }

        .dashboard-card {
            background-color: var(--card-color);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            /* Cards crescem com o conteúdo, garantindo o auto-ajuste */
            display: flex;
            flex-direction: column;
        }
        
        header img {
             background-color: white;
             padding: 4px;
             border-radius: 6px;
        }

        select,
        input[type="password"],
        input[type="text"],
        input[type="number"] {
            background-color: var(--bg-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 12px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1em;
            width: 100%;
        }
        
        select:focus,
        input:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 2px rgba(47, 128, 237, 0.5);
        }

        .kpi-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #222;
            border-radius: 10px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 10px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* --- ESTILOS DO NOVO FUNIL --- */
        .funnel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 1rem 0;
        }

        .funnel-stage {
            width: 100%;
            padding: 15px 20px;
            color: white;
            text-align: center;
            position: relative;
        }

        .funnel-stage.contatos {
            background-color: #2f80ed;
            clip-path: polygon(0% 0%, 100% 0%, 90% 100%, 10% 100%);
            border-radius: 5px 5px 0 0;
        }

        .funnel-stage.agendamentos {
            background-color: #2d9cdb;
            width: 90%;
            clip-path: polygon(0% 0%, 100% 0%, 90% 100%, 10% 100%);
        }

        .funnel-stage.comparecimentos {
            background-color: #56ccf2;
            color: #111;
            width: 80%;
            clip-path: polygon(0% 0%, 100% 0%, 85% 100%, 15% 100%);
        }

        .funnel-stage.fechamentos {
            background-color: #6fcf97;
            color: #111;
            width: 65%;
            border-radius: 0 0 5px 5px;
        }

        .stage-title {
            font-weight: 600;
            font-size: 1.1em;
        }

        .stage-value {
            font-weight: 800;
            font-size: 1.8em;
            /* Flexbox para alinhar o valor e o indicador de diferença */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .conversion-arrow {
            color: var(--text-secondary);
            font-weight: 700;
            padding: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .conversion-arrow.green {
            color: var(--green-light);
        }

        .conversion-arrow.orange {
            color: var(--orange);
        }

        .arrow-icon {
            font-size: 1.5em;
        }
    </style>
</head>

<body class="text-gray-300">
    <div class="container mx-auto p-4 md:p-8">
        <div id="input-section">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-[--text-primary]">Dashboard de Performance Estratégica</h1>
                <p class="text-md text-[--text-secondary] mt-2">Carregue a planilha de dados (`.csv`, `.xls`, `.xlsx`) para uma análise completa.</p>
            </header>
            <div class="max-w-4xl mx-auto p-6 rounded-lg dashboard-card">
                 <div class="space-y-4">
                    <div>
                        <label for="apiKey" class="block text-sm font-medium text-[--text-secondary] mb-1">Chave de API Gemini</label>
                        <input type="password" id="apiKey" placeholder="Insira sua API key Gemini" value="AIzaSyAbHxgCDpTSGvtfn3H3zNqALhsGU9ggawA">
                    </div>
                    <div class="grid md:grid-cols-2 gap-6 pt-4">
                        <!-- Input Semana Atual -->
                        <div>
                            <label for="fileUploadInputCurrent" class="block text-sm font-medium text-[--text-secondary] mb-1">Planilha da Semana Atual</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-[--border-color] border-dashed rounded-md">
                                <div class="space-y-1 text-center">
                                    <svg class="mx-auto h-12 w-12 text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    <div class="flex text-sm text-[--text-secondary]">
                                        <label for="fileUploadInputCurrent" class="relative cursor-pointer bg-transparent rounded-md font-medium text-[--green-light] hover:text-[--green] focus-within:outline-none">
                                            <span>Carregar planilha</span>
                                            <input id="fileUploadInputCurrent" name="fileUploadInputCurrent" type="file" class="sr-only" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                                        </label>
                                        <p class="pl-1">ou arraste</p>
                                    </div>
                                    <p id="fileNameCurrent" class="text-xs text-gray-500">.csv, .xls, .xlsx</p>
                                </div>
                            </div>
                        </div>
                        <!-- Input Semana Passada -->
                        <div>
                            <label for="fileUploadInputLastWeek" class="block text-sm font-medium text-[--text-secondary] mb-1">Semana Passada (Opcional)</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-[--border-color] border-dashed rounded-md">
                                <div class="space-y-1 text-center">
                                     <svg class="mx-auto h-12 w-12 text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    <div class="flex text-sm text-[--text-secondary]">
                                        <label for="fileUploadInputLastWeek" class="relative cursor-pointer bg-transparent rounded-md font-medium text-[--blue] hover:text-blue-400 focus-within:outline-none">
                                            <span>Carregar planilha</span>
                                            <input id="fileUploadInputLastWeek" name="fileUploadInputLastWeek" type="file" class="sr-only" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                                        </label>
                                        <p class="pl-1">ou arraste</p>
                                    </div>
                                    <p id="fileNameLastWeek" class="text-xs text-gray-500">Para comparação</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <button id="processButton" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[--green] hover:bg-[--green-light] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[--green]">
                        Analisar Relatório 🚀
                    </button>
                </div>
            </div>
        </div>

        <div id="loader-section" class="hidden text-center py-12">
            <div class="flex justify-center items-center space-x-2">
                <div class="w-4 h-4 rounded-full bg-[--green] animate-pulse [animation-delay:-0.3s]"></div>
                <div class="w-4 h-4 rounded-full bg-[--green] animate-pulse [animation-delay:-0.15s]"></div>
                <div class="w-4 h-4 rounded-full bg-[--green] animate-pulse"></div>
            </div>
            <h2 class="text-xl font-semibold mt-6 text-[--text-primary]">Analisando...</h2>
            <p id="loader-text" class="text-[--text-secondary] transition-all duration-300">Processando arquivo e gerando insights...</p>
        </div>

        <div id="results-section" class="hidden space-y-8 mt-8">
            <header class="mb-8 flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-[--text-primary]">Dashboard de Performance Estratégica</h1>
                    <p class="text-[--text-secondary]">Agência: Sato7 | Cliente: Oral Sin Implantes | Mês: Agosto/2025</p>
                </div>
            </header>
            
            <!-- NOVO PAINEL DE UNIDADES QUE ATINGIRAM A META -->
            <div id="goal-achievers-panel" class="mb-8"></div>
            
            <div id="consolidated-kpis" class="grid grid-cols-2 lg:grid-cols-5 gap-6 mb-8"></div>
            
            <div id="filter-bar" class="dashboard-card mb-8 sticky top-4 z-20">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="unitFilter" class="block text-sm font-medium text-[--text-secondary]">🔎 Filtro por Unidade</label>
                        <select id="unitFilter" class="mt-1 block w-full"></select>
                    </div>
                    <div>
                        <label for="performanceFilter" class="block text-sm font-medium text-[--text-secondary]">🚦 Filtro por Performance</label>
                        <select id="performanceFilter" class="mt-1 block w-full">
                            <option value="all">Todas as Faixas</option>
                            <option value="under70">Abaixo de 70% (Crítico)</option>
                            <option value="watchlist">Entre 70% e 90% (Atenção)</option>
                            <option value="ok">Acima de 90% (OK)</option>
                        </select>
                    </div>
                    <div>
                        <button id="resetFilters" class="w-full flex justify-center items-center py-2 px-4 border border-[--border-color] rounded-md shadow-sm text-sm font-medium text-[--text-primary] bg-[--card-color] hover:bg-[--border-color]">
                            Limpar Filtros
                        </button>
                    </div>
                </div>
            </div>

            <div id="data-hygiene-banner" class="hidden"></div>
            
            <!-- SEÇÃO DE FOCO PRINCIPAL -->
            <div id="attention-banner" class="hidden space-y-4"></div>


            <div id="single-unit-view" class="hidden space-y-8">
                <div id="unit-gaps-section"></div>
                <div id="funnel-analysis-section"></div>
                <div id="comparative-analysis-section" class="dashboard-card"></div>
                <div id="radar-chart-section" class="dashboard-card">
                    <h2 class="text-xl font-bold text-[--text-primary]">📡 Radar de Eficiência da Unidade</h2>
                    <p class="text-sm text-[--text-secondary] mb-4">Analisa os pontos fortes e fracos da clínica em relação à média da rede, ajudando a direcionar o foco.</p>
                    <div id="radar-chart-container"></div>
                </div>
                <div id="playbooks-section"></div>
            </div>

            <div id="aggregate-view" class="space-y-8">
                <!-- Seções Reordenadas para Prioridade -->
                <div class="dashboard-card">
                    <h2 class="text-xl font-bold text-[--text-primary]">🚨 Prioridades de Recuperação Online</h2>
                    <p class="text-sm text-[--text-secondary] mb-4">Unidades mais distantes de atingir 70% da meta total com faturamento de mídia online. A análise da IA sugere ações para os casos mais críticos.</p>
                    <div id="recovery-priorities-chart"></div>
                    <div id="recovery-ai-analysis" class="mt-4"></div>
                </div>

                <div id="performance-rankings" class="space-y-8"></div>
                <div id="conversion-rankings" class="space-y-8"></div>
                
                <div class="dashboard-card">
                    <h2 class="text-xl font-bold text-[--text-primary]">🚧 Principais Gargalos de Conversão</h2>
                    <p class="text-sm text-[--text-secondary] mb-4">Mostra em qual etapa do funil as unidades com baixo desempenho mais perdem clientes, apontando para problemas de processo.</p>
                    <div id="bottleneck-chart"></div>
                </div>
                 <div class="dashboard-card">
                    <h2 class="text-xl font-bold text-[--text-primary]">🎯 Funil de Vendas Agregado</h2>
                    <p class="text-sm text-[--text-secondary] mb-4">Visão completa das etapas de conversão, comparando o realizado com as metas para identificar perdas.</p>
                    <div id="funnel-chart-container" class="py-4 overflow-x-auto"></div>
                </div>
                <div class="dashboard-card">
                    <h2 class="text-xl font-bold text-[--text-primary]">🗺️ Análise Regional de Performance</h2>
                    <p class="text-sm text-[--text-secondary] mb-4">Compara o desempenho consolidado entre as regiões. O ranking de unidades dentro de cada região é baseado na porcentagem da meta de faturamento atingida.</p>
                    <div id="regional-analysis-container"></div>
                </div>
                <div class="dashboard-card">
                    <h2 class="text-xl font-bold text-[--text-primary]">🌐 Análise de Share Online</h2>
                    <p class="text-sm text-[--text-secondary] mb-4">Classifica as unidades pela dependência do faturamento de mídia online, destacando oportunidades de crescimento em canais digitais ou necessidade de fortalecer a receita offline.</p>
                    
                    <div id="ai-online-share-explanation" class="mb-6 p-3 bg-blue-900/50 text-blue-300 rounded-md text-sm border border-blue-500/50">
                        Analisando a importância estratégica do share online...
                    </div>
                    <div id="online-share-container" class="mt-4"></div>
                </div>
                <div class="dashboard-card mb-8">
                    <h2 class="text-xl font-bold text-[--text-primary]">🛠️ Alavancas Online para Atingir 70% da Meta Total</h2>
                    <p class="text-sm text-[--text-secondary] mb-4">Calcula o esforço operacional (novos leads, agendamentos, etc.) necessário para cada unidade crítica atingir 70% de sua meta total, considerando apenas os canais de mídia online.</p>
                    <div id="levers-table" class="table-container"></div>
                </div>
                <div id="team-comparison-section" class="dashboard-card"></div>
            </div>

            <div class="text-center pt-4">
                <button id="resetButton" class="py-2 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Analisar Outro Relatório</button>
            </div>
        </div>

        <footer class="mt-12 text-center text-[--text-secondary] space-y-4">
            <details class="group">
                <summary class="cursor-pointer text-sm font-medium hover:text-[--text-primary]">
                    🔍 Exibir Relatório de Inconsistências de Dados
                </summary>
                <div id="inconsistency-report-container" class="mt-4 text-left dashboard-card p-4 text-xs max-w-3xl mx-auto">
                </div>
            </details>
            <details class="group">
                <summary class="cursor-pointer text-sm font-medium hover:text-[--text-primary]">
                    Exibir Detalhes da Implementação
                </summary>
                <div class="mt-4 text-left dashboard-card p-4 text-xs max-w-3xl mx-auto">
                    <h4 class="font-bold text-[--text-primary] mb-2">Como este Dashboard Funciona:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Carregamento de Dados:</strong> O dashboard utiliza a biblioteca <code class="bg-[--border-color] px-1 rounded">xlsx.full.min.js</code> para ler arquivos de planilha (.xlsx, .csv) diretamente no navegador, sem enviar dados para um servidor.</li>
                        <li><strong>Validação e Enriquecimento:</strong> Uma camada de "IA" no código valida as colunas da planilha, padroniza nomes, recalcula todas as métricas internamente para garantir precisão e atribui unidades a regiões do Brasil. Alertas de "higiene de dados" são gerados para inconsistências.</li>
                        <li><strong>Reatividade aos Filtros:</strong> Todos os gráficos e KPIs são recalculados dinamicamente sempre que um filtro é alterado. O estado dos filtros é salvo na URL para permitir o compartilhamento de visualizações específicas.</li>
                        <li><strong>Visualização de Dados:</strong> Os gráficos são renderizados com a biblioteca <code class="bg-[--border-color] px-1 rounded">ApexCharts</code>, que permite criar visualizações interativas como o funil, matrizes de dispersão e o radar de performance.</li>
                        <li><strong>Interface e Estilo:</strong> A interface é construída com <code class="bg-[--border-color] px-1 rounded">Tailwind CSS</code>, garantindo um design moderno, limpo e totalmente responsivo para desktops e dispositivos móveis.</li>
                    </ul>
                </div>
            </details>
        </footer>


        <div id="error-section" class="hidden max-w-2xl mx-auto bg-red-900/50 border border-red-500/50 text-red-300 px-4 py-3 rounded-lg relative mt-6" role="alert">
            <strong class="font-bold">Ocorreu um erro!</strong>
            <span class="block sm:inline" id="error-message"></span>
        </div>
    </div>

    <script>
        // --- DATABASE E BENCHMARKS ---
        let fullData = [];
        let fullDataLastWeek = [];
        let uploadedFile = null;
        let uploadedFileLastWeek = null;
        let medians = {};
        const networkBenchmarks = { // Fallback
            conv_la: 0.4412,
            conv_ac: 0.5164,
            conv_cf: 0.3333,
            conv_lf: 0.0874,
            tkm_online: 8064.37,
            rpl: 612.97,
            share_online: 0.5891
        };

        // --- ELEMENTOS DO DOM ---
        const [inputSection, loaderSection, resultsSection, errorSection, errorMessage, apiKeyInput, fileUploadInputCurrent, fileNameCurrent, processButton, resetButton, loaderText, unitFilter, performanceFilter, resetFiltersBtn, funnelAnalysisSection, playbooksSection, dataHygieneBanner, singleUnitView, aggregateView, quickWinsContainer, consolidatedKpis, agencyNarrative] = [
            'input-section', 'loader-section', 'results-section', 'error-section', 'error-message', 'apiKey', 'fileUploadInputCurrent', 'fileNameCurrent', 'processButton', 'resetButton', 'loader-text', 'unitFilter', 'performanceFilter', 'resetFilters', 'funnel-analysis-section', 'playbooks-section', 'data-hygiene-banner', 'single-unit-view', 'aggregate-view', 'quickWinsContainer', 'consolidated-kpis', 'agency-narrative'
        ].map(id => document.getElementById(id));
        const fileUploadInputLastWeek = document.getElementById('fileUploadInputLastWeek');
        const fileNameLastWeek = document.getElementById('fileNameLastWeek');


        let activeCharts = {};

        // --- LÓGICA DE EVENTOS ---
        window.addEventListener('DOMContentLoaded', () => {
            const filters = readURL();
            if (filters.unit || filters.performance) {
                // Se houver filtros na URL, talvez queira acionar o carregamento se o arquivo já estiver em cache
            }
        });

        fileUploadInputCurrent.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                uploadedFile = file;
                fileNameCurrent.textContent = file.name;
            }
        });

        fileUploadInputLastWeek.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                uploadedFileLastWeek = file;
                fileNameLastWeek.textContent = file.name;
            }
        });

        processButton.addEventListener('click', async () => {
            if (!uploadedFile) {
                showError('Por favor, faça o upload da planilha da semana ATUAL.');
                return;
            }
            hideError();
            inputSection.classList.add('hidden');
            loaderSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            try {
                loaderText.textContent = 'Lendo e processando a planilha ATUAL...';
                const data = await parseSpreadsheet(uploadedFile);
                
                let dataLastWeek = [];
                if(uploadedFileLastWeek) {
                     loaderText.textContent = 'Lendo e processando a planilha da SEMANA PASSADA...';
                     dataLastWeek = await parseSpreadsheet(uploadedFileLastWeek);
                }


                loaderText.textContent = 'Enriquecendo dados e calculando métricas...';

                let temp_data = enrichData(data);
                medians = calculateMedians(temp_data); 
                fullData = temp_data.map(row => ({ ...row, worst_stage: calculateWorstStage(row, medians) }));
                
                fullDataLastWeek = enrichData(dataLastWeek);


                updateDashboard(fullData);
            } catch (error) {
                console.error('Erro detalhado no processo:', error);
                showError(`Falha ao analisar o relatório. Detalhes: ${error.message}`);
                loaderSection.classList.add('hidden');
                inputSection.classList.remove('hidden');
            }
        });

        resetButton.addEventListener('click', () => {
            uploadedFile = null;
            uploadedFileLastWeek = null;
            fileNameCurrent.textContent = '.csv, .xls, .xlsx';
            fileNameLastWeek.textContent = 'Para comparação';
            fileUploadInputCurrent.value = '';
            fileUploadInputLastWeek.value = '';
            
            resultsSection.classList.add('hidden');
            inputSection.classList.remove('hidden');
            loaderSection.classList.add('hidden');
            hideError();
            updateURL({}); // Limpa a URL
            Object.values(activeCharts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            activeCharts = {};
        });

        [unitFilter, performanceFilter].forEach(filter => filter.addEventListener('change', applyFilters));
        resetFiltersBtn.addEventListener('click', () => {
            unitFilter.value = 'all';
            performanceFilter.value = 'all';
            applyFilters();
        });

        // --- PROCESSAMENTO DE DADOS ---
        const parseValue = (value) => {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                const cleaned = value.replace('R$', '').replace(/\./g, '').replace(/,/g, '.').trim();
                const number = parseFloat(cleaned);
                return isNaN(number) ? 0 : number;
            }
            return 0;
        };

        function parseSpreadsheet(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, {
                            type: 'array',
                            cellDates: true
                        });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        resolve(XLSX.utils.sheet_to_json(worksheet));
                    } catch (e) {
                        reject(new Error("Não foi possível ler o arquivo. Verifique o formato e as colunas."));
                    }
                };
                reader.onerror = (error) => reject(error);
                reader.readAsArrayBuffer(file);
            });
        }
        
        const cityToStateMap = {
            'SP': ['Bauru', 'Barretos', 'São Paulo', 'São José do Rio Preto', 'São Carlos', 'Amparo', 'Araraquara', 'Araçatuba', 'Bragança Paulista', 'Caieiras', 'Fernandópolis', 'Jaguariúna', 'Leme', 'Mogi Guaçu', 'Monte Alto', 'Pirassununga', 'Ribeirão Preto', 'Rio Claro', 'Santa Cruz do Rio Pardo', 'Santo André', 'Sertãozinho', 'Sorocaba', 'Sumaré', 'São João da Boa Vista', 'Campinas', 'Guarulhos', 'Osasco', 'Santos', 'Porto Ferreira'],
            'MG': ['Betim', 'Contagem', 'Belo Horizonte', 'Varginha', 'Três Corações', 'Poços de Caldas', 'Pouso Alegre', 'Montes Claros', 'Juiz de Fora', 'Divinópolis', 'Conselheiro Lafaiete', 'Alfenas', 'Monte Carmelo', 'Sete Lagoas', 'São João Del Rei', 'Uberlândia'],
            'RJ': ['Barra Mansa', 'Volta Redonda', 'Rio de Janeiro', 'Niterói', 'Duque de Caxias', 'Campos dos Goytacazes', 'Petrópolis'],
            'ES': ['Vitória', 'Vila Velha'],
            'PR': ['Mandaguari', 'Ponta Grossa', 'Pinhais', 'Foz Do Iguaçu', 'Cornélio Procópio', 'Umuarama', 'Toledo', 'Londrina', 'Fazenda Rio Grande', 'Colombo', 'Ivaiporã', 'Jacarezinho', 'Jandaia do Sul', 'Maringá', 'Paiçandu', 'Pitanga', 'Curitiba', 'Cascavel'],
            'SC': ['Joinville', 'Itapema', 'Florianópolis', 'Blumenau', 'Balneário Camboriú', 'Caçador', 'Guaramirim', 'Içara', 'Lages', 'Mafra', 'Videira', 'Criciúma', 'Chapecó'],
            'RS': ['Torres', 'Rio Grande', 'Pelotas', 'Passo Fundo', 'Caxias do Sul', 'Camaquã', 'Montenegro', 'Novo Hamburgo', 'Sarandi - RS', 'Porto Alegre', 'Santa Maria', 'Canoas'],
            'GO': ['Goianésia', 'Cristalina', 'Anápolis', 'Caldas Novas', 'Morrinhos', 'Goiânia'],
            'DF': ['Brasília'],
            'MS': ['Campo Grande', 'Dourados'],
            'MT': ['Cuiabá', 'Várzea Grande', 'Rondonópolis'],
            'BA': ['Luis Eduardo Magalhães', 'Salvador', 'Itabuna', 'Ilhéus', 'Alagoinhas', 'Lauro de Freitas', 'Teixeira de Freitas', 'Vitória da Conquista', 'Feira de Santana', 'Juazeiro'],
            'AL': ['Maceió', 'Arapiraca'],
            'CE': ['Fortaleza', 'Juazeiro do Norte', 'Maracanaú'],
            'SE': ['Aracaju', 'Itabaiana'],
            'PE': ['Recife', 'Jaboatão dos Guararapes', 'Caruaru', 'Petrolina'],
            'MA': ['São Luís', 'Imperatriz'],
            'PB': ['João Pessoa', 'Campina Grande'],
            'RN': ['Natal'],
            'PI': ['Teresina'],
            'PA': ['Castanhal', 'Paragominas', 'Belém', 'Santarém', 'Ananindeua', 'Marabá'],
            'AM': ['Manaus'],
            'RO': ['Porto Velho'], 'AP': ['Macapá'], 'RR': ['Boa Vista'], 'AC': ['Rio Branco'], 'TO': ['Palmas']
        };
        
        function getStateFromCity(city) {
            if (!city) return null;
            const cityLower = city.toLowerCase().split(' - ')[0].trim();
            for (const state in cityToStateMap) {
                if (cityToStateMap[state].some(c => c.toLowerCase() === cityLower)) {
                    return state;
                }
            }
            return null;
        }


        const cityToRegionMap = {
            'sudeste': ['Bauru', 'Barretos', 'Betim', 'Barra Mansa', 'São Paulo - Guaianases', 'Contagem', 'Belo Horizonte - Prado', 'Volta Redonda', 'Varginha', 'Três Corações', 'São José do Rio Preto', 'São Carlos', 'Rio de Janeiro - Campo Grande', 'Poços de Caldas', 'Pouso Alegre', 'Montes Claros', 'Juiz de Fora', 'Divinópolis', 'Conselheiro Lafaiete', 'Alfenas', 'Amparo', 'Araraquara', 'Araçatuba', 'Bragança Paulista', 'Caieiras', 'Fernandópolis', 'Jaguariúna', 'Leme', 'Mogi Guaçu', 'Monte Alto', 'Monte Carmelo', 'Pirassununga', 'Ribeirão Preto', 'Rio Claro', 'Santa Cruz do Rio Pardo', 'Santo André', 'Sertãozinho', 'Sete Lagoas', 'Sorocaba', 'Sumaré', 'São João Del Rei', 'São João da Boa Vista', 'Uberlândia', 'Campinas', 'Guarulhos', 'Osasco', 'Santos', 'Niterói', 'Duque de Caxias', 'Vitória', 'Vila Velha', 'Campos dos Goytacazes', 'Petrópolis', 'Porto Ferreira'],
            'sul': ['Mandaguari', 'Ponta Grossa', 'Pinhais', 'Foz Do Iguaçu', 'Torres', 'Cornélio Procópio', 'Umuarama', 'Toledo', 'Rio Grande', 'Pelotas', 'Passo Fundo', 'Londrina', 'Joinville', 'Itapema', 'Florianópolis', 'Caxias do Sul', 'Blumenau', 'Balneário Camboriú', 'Fazenda Rio Grande', 'Camaquã', 'Caçador', 'Colombo', 'Guaramirim', 'Ivaiporã', 'Içara', 'Jacarezinho', 'Jandaia do Sul', 'Lages', 'Mafra', 'Maringá', 'Montenegro', 'Novo Hamburgo', 'Paiçandu', 'Pitanga', 'Sarandi - RS', 'Videira', 'Curitiba', 'Porto Alegre', 'Criciúma', 'Chapecó', 'Santa Maria', 'Cascavel', 'Canoas'],
            'centro-oeste': ['Goianésia', 'Cristalina', 'Anápolis', 'Caldas Novas', 'Morrinhos', 'Brasília', 'Goiânia', 'Campo Grande', 'Cuiabá', 'Várzea Grande', 'Rondonópolis', 'Dourados'],
            'nordeste': ['Luis Eduardo Magalhães', 'Salvador - Ondina', 'Maceió - Jatiúca', 'Itabuna', 'Ilhéus', 'Fortaleza - Aldeota', 'Aracaju', 'Alagoinhas', 'Arapiraca', 'Itabaiana', 'Juazeiro do Norte', 'Lauro de Freitas', 'Maracanaú', 'Recife', 'Teixeira de Freitas', 'Vitória da Conquista', 'São Luís', 'João Pessoa', 'Natal', 'Teresina', 'Jaboatão dos Guararapes', 'Campina Grande', 'Feira de Santana', 'Caruaru', 'Petrolina', 'Imperatriz', 'Juazeiro'],
            'norte': ['Manaus - Adrianópolis', 'Castanhal', 'Paragominas', 'Belém', 'Porto Velho', 'Macapá', 'Boa Vista', 'Rio Branco', 'Palmas', 'Santarém', 'Ananindeua', 'Marabá']
        };

        function getRegionFromCity(city) {
            if (!city) return 'Não Identificada';
            const cityLower = city.toLowerCase();
            for (const region in cityToRegionMap) {
                if (cityToRegionMap[region].some(c => cityLower.includes(c.toLowerCase().split(' - ')[0]))) {
                    return region.charAt(0).toUpperCase() + region.slice(1);
                }
            }
            return 'Não Identificada';
        }

        function enrichData(data) {
            const columnMapping = {
                clinic: ['clínica', 'clinica'],
                revenue: ['faturamento'],
                revenue_online: ['faturamento mídia online'],
                seasonal_goal: ['meta sazonal', 'meta mensal'],
                original_pct_meta: ['% meta'],
                leads: ['leads mídia online'],
                agends: ['agendamentos mídia online'],
                compares: ['comparecimentos mídia online'],
                closes: ['fechamentos mídia online'],
                meta_leads: ['meta leads'],
                meta_agends: ['meta agendamentos'],
                meta_compares: ['meta comparecimentos'],
                meta_closes: ['meta fechamentos'],
            };

            const findHeader = (headers, possibleNames) => {
                const lowerHeaders = headers.map(h => h.toLowerCase().trim());
                for (const name of possibleNames) {
                    const index = lowerHeaders.indexOf(name);
                    if (index !== -1) return headers[index];
                }
                return null;
            };

            if (data.length === 0) return [];
            const headers = Object.keys(data[0]);
            const resolvedHeaders = {};
            for (const key in columnMapping) {
                resolvedHeaders[key] = findHeader(headers, columnMapping[key]);
            }

            const filteredData = data.filter(row => {
                const clinicName = row[resolvedHeaders.clinic];
                return clinicName && clinicName.toString().toLowerCase().trim() !== 'total';
            });

            return filteredData.map(row => {
                const clinicName = row[resolvedHeaders.clinic];
                const revenue = parseValue(row[resolvedHeaders.revenue]);
                const meta_sazonal = parseValue(row[resolvedHeaders.seasonal_goal]);
                const leads = parseValue(row[resolvedHeaders.leads]);
                const agends = parseValue(row[resolvedHeaders.agends]);
                const compares = parseValue(row[resolvedHeaders.compares]);
                const closes = parseValue(row[resolvedHeaders.closes]);
                const revenue_online = parseValue(row[resolvedHeaders.revenue_online]);

                // Cálculos internos para garantir precisão
                const tkm_online = closes > 0 ? revenue_online / closes : 0;
                const pct_meta = meta_sazonal > 0 ? revenue / meta_sazonal : 0;
                const conv_la = leads > 0 ? agends / leads : 0;
                const conv_ac = agends > 0 ? compares / agends : 0;
                const conv_cf = compares > 0 ? closes / compares : 0;
                const conv_lf = leads > 0 ? closes / leads : 0;
                const rpl = leads > 0 ? revenue_online / leads : 0;
                const share_online = revenue > 0 ? revenue_online / revenue : 0;
                const under70 = pct_meta < 0.7;
                const gap_to_70 = under70 ? Math.max(0, (0.7 * meta_sazonal) - revenue) : 0;
                const add_closes_to_70 = tkm_online > 0 ? Math.ceil(gap_to_70 / tkm_online) : 0;
                const online_revenue_gap = Math.max(0, (meta_sazonal * 0.7) - revenue_online);

                const original_pct_meta_str = row[resolvedHeaders.original_pct_meta] || '0%';

                return {
                    Clínica: clinicName,
                    region: getRegionFromCity(clinicName),
                    state: getStateFromCity(clinicName),
                    revenue,
                    meta_sazonal,
                    leads,
                    agends,
                    compares,
                    closes,
                    revenue_online,
                    tkm_online,
                    rpl,
                    pct_meta,
                    conv_la,
                    conv_ac,
                    conv_cf,
                    conv_lf,
                    share_online,
                    under70,
                    watchlist: pct_meta >= 0.7 && pct_meta < 0.9,
                    ok: pct_meta >= 0.9,
                    gap_to_70,
                    add_closes_to_70,
                    online_revenue_gap,
                    meta_leads: parseValue(row[resolvedHeaders.meta_leads]),
                    meta_agends: parseValue(row[resolvedHeaders.meta_agends]),
                    meta_compares: parseValue(row[resolvedHeaders.meta_compares]),
                    meta_closes: parseValue(row[resolvedHeaders.meta_closes]),
                    original_pct_meta_str,
                    worst_stage: 'N/A'
                };
            });
        }

        function calculateWorstStage(row, medians) {
            if (!row.under70 || row.leads === 0 || row.agends === 0 || row.compares === 0) {
                return 'N/A';
            }
            const ratios = {
                'Leads → Agend.': row.conv_la / (medians.conv_la || networkBenchmarks.conv_la),
                'Agend. → Comp.': row.conv_ac / (medians.conv_ac || networkBenchmarks.conv_ac),
                'Comp. → Fech.': row.conv_cf / (medians.conv_cf || networkBenchmarks.conv_cf)
            };
            for (const key in ratios) {
                if (!isFinite(ratios[key])) {
                    ratios[key] = 1;
                }
            }
            return Object.keys(ratios).reduce((a, b) => ratios[a] < ratios[b] ? a : b);
        }

        function calculateMedians(data) {
            const getMedian = (arr) => {
                if (arr.length === 0) return 0;
                const mid = Math.floor(arr.length / 2),
                    nums = [...arr].sort((a, b) => a - b);
                return arr.length % 2 !== 0 ? nums[mid] : (nums[mid - 1] + nums[mid]) / 2;
            };
            const keys = ['conv_la', 'conv_ac', 'conv_cf', 'conv_lf', 'tkm_online', 'rpl', 'gap_to_70', 'add_closes_to_70'];
            const calculatedMedians = {};
            keys.forEach(key => {
                const values = data.map(d => d[key]).filter(v => typeof v === 'number' && !isNaN(v) && v > 0);
                calculatedMedians[key] = values.length > 0 ? getMedian(values) : (networkBenchmarks[key] || 0);
            });
            return calculatedMedians;
        }

        // --- LÓGICA DE ATUALIZAÇÃO DO DASHBOARD ---
        function applyFilters() {
            const selectedUnit = unitFilter.value;
            const selectedPerformance = performanceFilter.value;
            updateURL({
                unit: selectedUnit,
                performance: selectedPerformance
            });
            let filteredData = fullData;
            if (selectedUnit !== 'all') {
                filteredData = filteredData.filter(item => item.Clínica === selectedUnit);
            }
            if (selectedPerformance !== 'all') {
                filteredData = filteredData.filter(item => {
                    if (selectedPerformance === 'under70') return item.under70;
                    if (selectedPerformance === 'watchlist') return item.watchlist;
                    if (selectedPerformance === 'ok') return item.ok;
                    return false;
                });
            }
            updateDashboard(filteredData, false);
        }

        function updateDashboard(data, repopulateFilters = true) {
            loaderSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');

            const isSingleUnitView = data.length === 1 && unitFilter.value !== 'all';

            if (repopulateFilters) {
                const filters = readURL();
                populateFilter(fullData, 'Clínica', unitFilter, true, filters.unit);
                performanceFilter.value = filters.performance || 'all';
            }

            // Chamadas de renderização reordenadas
            renderGoalAchieversPanel(fullData);
            renderConsolidatedKPIs(data);
            renderAttentionBanner(data);
            renderDataHygiene(data);
            

            if (isSingleUnitView) {
                singleUnitView.classList.remove('hidden');
                aggregateView.classList.add('hidden');
                renderGapsSection(data[0]);
                renderFunnelAndSimulator(data[0]);
                renderComparativeAnalysis(data[0], fullData);
                renderPlaybook(data[0]);
                renderRadarChart(data[0]);
            } else {
                singleUnitView.classList.add('hidden');
                aggregateView.classList.remove('hidden');

                // Ordem de prioridade
                renderRecoveryPriorities(data);
                renderPerformanceRankings(data); 
                renderConversionRankings(data);
                renderPriorityAndBottleneck(data);
                // Gráfico removido
                renderCustomFunnel(data);
                renderRegionalAnalysis(data);
                renderOnlineShareAnalysis(data);
                renderLeversTable(data);
                renderTeamComparison(fullData);
            }
            renderDataInconsistencyReport(fullData); 
        }

        function populateFilter(data, key, element, includeAll = true, selectedValue = 'all') {
            const currentValue = element.value;
            element.innerHTML = '';
            if (includeAll) {
                element.innerHTML = '<option value="all">Todas as Unidades</option>';
            }
            const unitNames = [...new Set(data.map(item => item[key]).filter(Boolean))].sort();
            unitNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                element.appendChild(option);
            });
            element.value = selectedValue === 'all' ? 'all' : (unitNames.includes(selectedValue) ? selectedValue : 'all');
        }

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(value || 0);
        const formatPercent = (value, decimals = 1) => `${((value || 0) * 100).toFixed(decimals)}%`;
        const formatNumber = (value) => new Intl.NumberFormat('pt-BR').format(Math.round(value || 0));

        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        
        function getComparisonVsLastWeekHTML(current, last, formatFn, invertColors = false) {
            if (last === undefined || last === null || last === 0) return '';
            const diff = (current / last) - 1;
            
            let color = 'text-gray-500';
            let arrow = '~';

            if(diff > 0.005) { // Threshold to avoid showing 0.0%
                 color = invertColors ? 'text-red-400' : 'text-green-400';
                 arrow = '▲';
            } else if (diff < -0.005) {
                 color = invertColors ? 'text-green-400' : 'text-red-400';
                 arrow = '▼';
            } else {
                return ''; // Don't show if difference is negligible
            }

            return `<span class="text-sm font-semibold ml-2 ${color}">(${arrow} ${formatPercent(Math.abs(diff), 0)} vs sem. ant.)</span>`;
        }

        function renderGoalAchieversPanel(data) {
            const container = document.getElementById('goal-achievers-panel');
            if (!container) return;

            // Filtra unidades entre 90% e 100% da meta
            const achievers = data.filter(d => d.pct_meta >= 0.90 && d.pct_meta <= 1);
            const achieversCount = achievers.length;

            // Filtra unidades que superaram 100% da meta
            const superAchievers = data.filter(d => d.pct_meta > 1);
            const superAchieversCount = superAchievers.length;


            let html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-blue-900/50 border border-blue-500/50 p-6 rounded-lg text-center flex flex-col">
                        <h3 class="text-lg font-semibold text-blue-300 mb-2">🏆 Unidades na Reta Final!</h3>
                        <p class="text-5xl font-bold text-white">${achieversCount}</p>
                        <p class="text-sm text-blue-200 mt-2">unidades atingiram entre 90% e 100% da meta.</p>
                        ${achieversCount > 0 ? `
                            <details class="mt-4 text-left text-xs text-blue-200 flex-grow">
                                <summary class="cursor-pointer font-bold mb-1">Ver Unidades</summary>
                                <ul class="list-disc list-inside columns-2 mt-2">
                                    ${achievers.map(u => `<li>${u.Clínica} (${formatPercent(u.pct_meta)})</li>`).join('')}
                                </ul>
                            </details>
                        ` : ''}
                    </div>
                    <div class="bg-green-900/50 border border-green-500/50 p-6 rounded-lg text-center flex flex-col">
                        <h3 class="text-lg font-semibold text-green-300 mb-2">🚀 Meta Superada!</h3>
                        <p class="text-5xl font-bold text-white">${superAchieversCount}</p>
                        <p class="text-sm text-green-200 mt-2">unidades ultrapassaram 100% da meta.</p>
                        ${superAchieversCount > 0 ? `
                            <details class="mt-4 text-left text-xs text-green-200 flex-grow">
                                <summary class="cursor-pointer font-bold mb-1">Ver Unidades</summary>
                                <ul class="list-disc list-inside columns-2 mt-2">
                                    ${superAchievers.sort((a,b) => b.pct_meta - a.pct_meta).map(u => `<li>${u.Clínica} (${formatPercent(u.pct_meta)})</li>`).join('')}
                                </ul>
                            </details>
                        ` : ''}
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function renderConsolidatedKPIs(data) {
            if (!data || data.length === 0) {
                consolidatedKpis.innerHTML = '';
                return;
            }
            // Calculate totals for current period
            const totalFaturamento = data.reduce((sum, item) => sum + item.revenue, 0);
            const totalLeads = data.reduce((sum, item) => sum + item.leads, 0);
            const totalCloses = data.reduce((sum, item) => sum + item.closes, 0);
            const avgTKM = data.length > 0 ? data.reduce((sum, item) => sum + item.tkm_online, 0) / data.filter(d => d.tkm_online > 0).length : 0;
            const convLF = totalLeads > 0 ? totalCloses / totalLeads : 0;
            const compConvLF = getComparisonVsBenchmark(convLF, medians.conv_lf);

            // Calculate totals for last week if data is available
            let lastWeekTotals = {};
            if (fullDataLastWeek && fullDataLastWeek.length > 0) {
                const lastWeekLeads = fullDataLastWeek.reduce((sum, item) => sum + item.leads, 0);
                const lastWeekCloses = fullDataLastWeek.reduce((sum, item) => sum + item.closes, 0);
                lastWeekTotals = {
                    faturamento: fullDataLastWeek.reduce((sum, item) => sum + item.revenue, 0),
                    leads: lastWeekLeads,
                    closes: lastWeekCloses,
                    tkm: fullDataLastWeek.length > 0 ? fullDataLastWeek.reduce((sum, item) => sum + item.tkm_online, 0) / fullDataLastWeek.filter(d => d.tkm_online > 0).length : 0,
                    convLF: lastWeekLeads > 0 ? lastWeekCloses / lastWeekLeads : 0,
                };
            }
            
            const urgentCount = fullData.filter(u => u.share_online < 0.4 && u.revenue > 0).length;
            const attentionCount = fullData.filter(u => u.share_online >= 0.4 && u.share_online < 0.6 && u.revenue > 0).length;
            const healthyCount = fullData.filter(u => u.share_online >= 0.6 && u.revenue > 0).length;

            let html = `
                <div class="kpi-card dashboard-card">
                    <h3 class="text-[--text-secondary] font-semibold">💰 Faturamento Total</h3>
                    <p class="text-3xl font-bold text-green-400 flex items-baseline">${formatCurrency(totalFaturamento)} ${getComparisonVsLastWeekHTML(totalFaturamento, lastWeekTotals.faturamento, formatCurrency)}</p>
                </div>
                <div class="kpi-card dashboard-card">
                    <h3 class="text-[--text-secondary] font-semibold">📥 Leads Totais</h3>
                    <p class="text-3xl font-bold text-[--text-primary] flex items-baseline">${formatNumber(totalLeads)} ${getComparisonVsLastWeekHTML(totalLeads, lastWeekTotals.leads, formatNumber)}</p>
                </div>
                <div class="kpi-card dashboard-card">
                    <h3 class="text-[--text-secondary] font-semibold">✍️ Fechamentos Totais</h3>
                    <p class="text-3xl font-bold text-[--text-primary] flex items-baseline">${formatNumber(totalCloses)} ${getComparisonVsLastWeekHTML(totalCloses, lastWeekTotals.closes, formatNumber)}</p>
                </div>
                <div class="kpi-card dashboard-card">
                    <h3 class="text-[--text-secondary] font-semibold">🎫 Ticket Médio</h3>
                    <p class="text-3xl font-bold text-[--text-primary] flex items-baseline">${formatCurrency(avgTKM)} ${getComparisonVsLastWeekHTML(avgTKM, lastWeekTotals.tkm, formatCurrency)}</p>
                </div>
                <div class="kpi-card dashboard-card lg:col-span-2">
                    <h3 class="text-[--text-secondary] font-semibold">🤝 Conversão Geral (L→F)</h3>
                     <p class="text-sm text-[--text-secondary] mb-2">Eficiência total do funil, de lead a cliente.</p>
                    <p class="text-3xl lg:text-4xl font-bold ${compConvLF.color} flex items-baseline">${formatPercent(convLF)} ${getComparisonVsLastWeekHTML(convLF, lastWeekTotals.convLF, formatPercent)}</p>
                    <div class="text-sm ${compConvLF.color}">${compConvLF.text}</div>
                </div>
                 <div class="lg:col-span-3 grid grid-cols-3 gap-4">
                    <div class="p-4 rounded-lg bg-red-900/50 border border-red-500/50 text-center">
                        <p class="text-sm font-medium text-red-300">Share Online Urgente</p>
                        <p class="text-3xl font-bold text-red-400" id="online-share-urgent">${urgentCount}</p>
                    </div>
                    <div class="p-4 rounded-lg bg-yellow-900/50 border border-yellow-500/50 text-center">
                        <p class="text-sm font-medium text-yellow-300">Share Online Atenção</p>
                        <p class="text-3xl font-bold text-yellow-400" id="online-share-attention">${attentionCount}</p>
                    </div>
                    <div class="p-4 rounded-lg bg-green-900/50 border border-green-500/50 text-center">
                        <p class="text-sm font-medium text-green-300">Share Online Saudável</p>
                        <p class="text-3xl font-bold text-green-400" id="online-share-healthy">${healthyCount}</p>
                    </div>
                </div>
            `;
            consolidatedKpis.innerHTML = html;
        }

        async function renderAttentionBanner(data) {
            const container = document.getElementById('attention-banner');
            const criticalUnits = data.filter(d => d.pct_meta < 0.5 && d.conv_la < (medians.conv_la * 0.8));
            
            if (criticalUnits.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            let html = `<h2 class="text-2xl font-bold text-yellow-400 mb-4">🚨 Unidades com Atenção Redobrada</h2>`;
            
            for (const unit of criticalUnits) {
                const analysisId = `attention-ai-${unit.Clínica.replace(/\s+/g, '')}`;
                html += `
                    <div class="dashboard-card mb-4">
                        <h3 class="font-bold text-lg text-yellow-400">${unit.Clínica}</h3>
                        <div id="${analysisId}" class="text-sm text-[--text-secondary] mt-2">
                           <div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full bg-yellow-400 animate-pulse"></div> <span>Analisando...</span></div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
            
             for (const unit of criticalUnits) {
                const analysisId = `attention-ai-${unit.Clínica.replace(/\s+/g, '')}`;
                const prompt = `A unidade ${unit.Clínica} apresenta uma taxa de conversão baixa entre leads recebidos (${unit.leads}) e agendados (${unit.agends}), resultando em uma conversão L->A de ${formatPercent(unit.conv_la)}, e um faturamento de apenas ${formatPercent(unit.pct_meta)} da meta. Analise este cenário e sugira uma estratégia concisa que vise melhorar a qualidade do agendamento ou entender por que a unidade não está conseguindo agendar.`;
                const analysisHTML = await generateAIAnalysis(prompt);
                document.getElementById(analysisId).innerHTML = analysisHTML;
            }
        }
        
        async function renderRegionalAnalysis(data) {
            const container = document.getElementById('regional-analysis-container');
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Sem dados para análise regional.</p>';
                return;
            }

            const regionalData = {};
            data.forEach(d => {
                if (d.region === 'Não Identificada') return;
                if (!regionalData[d.region]) {
                    regionalData[d.region] = [];
                }
                regionalData[d.region].push(d);
            });
            
            const unassignedUnits = data.filter(d => d.region === 'Não Identificada');

            let html = `<div id="regional-chart-bar"></div>`;
            
            html += '<div class="mt-8 space-y-4">';
            
            for (const regionName in regionalData) {
                const regionUnits = regionalData[regionName];
                const top5 = [...regionUnits].sort((a,b) => b.pct_meta - a.pct_meta).slice(0, 5);
                const worst5 = [...regionUnits].sort((a,b) => a.pct_meta - b.pct_meta).slice(0, 5);
                
                html += `
                <details class="bg-black/20 p-4 rounded-lg group">
                    <summary class="font-bold cursor-pointer hover:text-white">Análise da Região ${regionName} (${regionUnits.length} unidades)</summary>
                    <div class="mt-4">
                        <p class="text-xs text-gray-400 mb-4"><strong>Unidades:</strong> ${regionUnits.map(d => d.Clínica).join(', ')}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold text-center mb-2 text-green-400">Top 5 Melhores</h4>
                                <ul class="space-y-1 text-sm">
                                ${top5.map((d,i) => `<li class="flex justify-between text-xs border-b border-gray-800/50 py-1"><span class="truncate">${i+1}. ${d.Clínica}</span><strong class="text-green-400">${formatPercent(d.pct_meta)}</strong></li>`).join('')}
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-center mb-2 text-red-400">Top 5 Piores</h4>
                                 <ul class="space-y-1 text-sm">
                                ${worst5.map((d,i) => `<li class="flex justify-between text-xs border-b border-gray-800/50 py-1"><span class="truncate">${i+1}. ${d.Clínica}</span><strong class="text-red-400">${formatPercent(d.pct_meta)}</strong></li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                </details>
                `;
            }
            html += '</div>';

            if (unassignedUnits.length > 0) {
                 html += `
                <div class="mt-8 bg-yellow-900/50 p-4 rounded-lg border border-yellow-500/50">
                    <h3 class="font-bold text-yellow-300">⚠️ Unidades Sem Região Definida (${unassignedUnits.length})</h3>
                    <p class="text-xs text-yellow-200 mt-2">${unassignedUnits.map(d => d.Clínica).join(', ')}</p>
                </div>`;
            }

            html += `<div class="mt-6 text-center">
                        <button id="show-regional-ai" class="py-2 px-4 border border-[--border-color] rounded-md text-sm font-medium text-[--text-primary] hover:bg-[--border-color]">Ver Insights da IA por Região</button>
                     </div>
                     <div id="regional-ai-insights-container" class="mt-4 space-y-4"></div>`;

            container.innerHTML = html;

            document.getElementById('show-regional-ai').addEventListener('click', () => renderAllRegionalAI(regionalData));

             const chartData = Object.keys(regionalData).map(region => ({
                 x: region,
                 y: regionalData[region].reduce((sum, d) => sum + d.revenue, 0)
             })).sort((a,b) => b.y - a.y);
             
             renderChart('regional-chart-bar', { 
                 series: [{ name: 'Faturamento', data: chartData.map(d => d.y) }], 
                 chart: { type: 'bar', height: 350, toolbar: {show: false} }, 
                 xaxis: { categories: chartData.map(d => d.x) }, 
                 yaxis: { labels: { formatter: val => formatCurrency(val) } }, 
                 dataLabels: { enabled: false }, 
                 colors: ['var(--green)']
             });
         }
        
        async function renderAllRegionalAI(regionalData) {
            const container = document.getElementById('regional-ai-insights-container');
            const button = document.getElementById('show-regional-ai');
            button.disabled = true;
            container.innerHTML = `<div class="text-center"><div class="flex justify-center items-center space-x-2"><div class="w-4 h-4 rounded-full bg-blue-400 animate-pulse"></div> <span>Gerando insights para todas as regiões...</span></div></div>`;

            let insightsHTML = '';
            for (const region in regionalData) {
                const prompt = `Analise o contexto econômico e de mercado para a região '${region}' do Brasil no período de Agosto de 2025, com foco no setor de saúde e odontologia. Com base em notícias e tendências, forneça uma breve explicação (2-3 frases) que possa contextualizar o desempenho de clínicas odontológicas na região. Por exemplo, se há notícias sobre aumento de renda, poder de compra, ou campanhas de saúde locais.`;
                const analysis = await generateAIAnalysis(prompt);
                insightsHTML += `<div class="p-4 bg-black/20 rounded-lg">
                                    <h4 class="font-bold text-blue-300">${region}</h4>
                                    <p class="text-sm mt-2">${analysis}</p>
                                 </div>`;
            }
            container.innerHTML = insightsHTML;
            button.disabled = false;
        }

        async function generateAIAnalysis(prompt, retries = 3, delay = 1000) {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                return "Insira uma chave de API Gemini para obter a análise por IA.";
            }

            const payload = {
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }],
                tools: [{
                    "google_search": {}
                }],
            };

            for (let i = 0; i <= retries; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                            return result.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
                        } else {
                            // This case handles a valid response that is empty.
                            return "Não foi possível gerar a análise da IA: resposta inválida.";
                        }
                    }

                    if (response.status === 429 || response.status >= 500) {
                        if (i === retries) {
                            // Last retry failed, return a user-friendly error message.
                            return `Não foi possível gerar a análise da IA após várias tentativas. (Erro: ${response.status})`;
                        }
                        // Wait for the next retry with exponential backoff.
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                        continue; // Go to the next iteration of the loop.
                    }

                    // For other client-side errors (4xx), don't retry.
                    const errorText = await response.text();
                    return `Não foi possível gerar a análise da IA. (Erro: ${response.status} - ${errorText})`;

                } catch (e) {
                    if (i === retries) {
                        // Last retry failed due to a network error, etc.
                        console.error("Erro final na análise por IA:", e); // Log only the final error.
                        return `Não foi possível gerar a análise da IA. Verifique a conexão. Detalhes: ${e.message}.`;
                    }
                    // Wait before the next retry.
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
            // This will be reached if all retries fail.
            return "Não foi possível gerar a análise da IA após várias tentativas.";
        }

        async function generateStructuredAIAnalysis(prompt, schema, retries = 3, delay = 1000) {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                return null;
            }

            const payload = {
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema,
                }
            };
            
            for (let i = 0; i <= retries; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates ?.[0]?.content?.parts ?.[0]?.text) {
                            return JSON.parse(result.candidates[0].content.parts[0].text);
                        }
                        return null; // Handle empty but valid response
                    }

                    if (response.status === 429 || response.status >= 500) {
                        if (i === retries) {
                            console.error(`Erro final na análise estruturada por IA: ${response.status}`);
                            return null;
                        }
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                        continue;
                    }

                    // Other client-side errors, don't retry
                    console.error(`Erro na análise estruturada por IA: ${response.status}`);
                    return null;

                } catch (e) {
                    if (i === retries) {
                        console.error("Erro final de rede na análise estruturada por IA:", e);
                        return null;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
            return null;
        }


        function renderCustomFunnel(data) {
            const container = document.getElementById('funnel-chart-container');
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Sem dados para exibir o funil.</p>';
                return;
            }

            const realized = {
                leads: data.reduce((sum, d) => sum + d.leads, 0),
                agends: data.reduce((sum, d) => sum + d.agends, 0),
                compares: data.reduce((sum, d) => sum + d.compares, 0),
                closes: data.reduce((sum, d) => sum + d.closes, 0)
            };
            container.innerHTML = createFunnelHTML(realized);
        }

        async function renderPerformanceRankings(data) {
            const container = document.getElementById('performance-rankings');
            if (!data || data.length === 0) {
                container.innerHTML = "";
                return;
            }
            
            const metricDetails = {
                leads: { title: 'Leads Recebidos', goalKey: 'meta_leads' },
                agends: { title: 'Agendamentos', goalKey: 'meta_agends' },
                compares: { title: 'Comparecimentos', goalKey: 'meta_compares' },
                closes: { title: 'Fechamentos', goalKey: 'meta_closes' },
            };

            const getPerfColor = (percent) => {
                if (percent >= 1) return 'text-green-400';
                if (percent >= 0.7) return 'text-yellow-400';
                return 'text-red-400';
            };

            let html = `
            <div class="dashboard-card">
                 <h2 class="text-2xl font-bold text-[--text-primary] mb-4">🏆 Rankings de Performance Absoluta</h2>
                 <!-- MELHORES UNIDADES -->
                 <div>
                    <h3 class="text-xl font-semibold text-green-400 mb-4">⭐ As Melhores Unidades</h3>
                    <p class="text-sm text-[--text-secondary] -mt-3 mb-4">Classifica as unidades com os maiores números absolutos em cada indicador (Leads, Agendamentos, etc.), mostrando quem mais gera volume.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="best-performers"></div>
                    <div id="best-performers-ai" class="mt-6 p-4 bg-black/20 rounded-lg"></div>
                 </div>
                 <hr class="border-t border-[--border-color] my-8">
                 <!-- PIORES UNIDADES -->
                 <div>
                    <h3 class="text-xl font-semibold text-red-400 mb-4">📉 As Piores Unidades</h3>
                    <p class="text-sm text-[--text-secondary] -mt-3 mb-4">Classifica as unidades com o menor percentual de atingimento da meta para cada indicador, mostrando quem está mais longe do objetivo.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="worst-performers"></div>
                    <div id="worst-performers-ai" class="mt-6 p-4 bg-black/20 rounded-lg"></div>
                 </div>
            </div>`;
            container.innerHTML = html;

            const bestPerformersContainer = document.getElementById('best-performers');
            const worstPerformersContainer = document.getElementById('worst-performers');
            
            let bestHtml = '';
            let worstHtml = '';

            for (const key in metricDetails) {
                const metric = metricDetails[key];
                
                // Top 10 by absolute number
                const top10 = [...data].sort((a, b) => b[key] - a[key]).slice(0, 10);
                bestHtml += `<div class="bg-black/20 p-4 rounded-lg">
                                <h4 class="font-bold mb-3 text-center">${metric.title}</h4>
                                <div class="text-sm space-y-3">`;
                top10.forEach((d, i) => {
                    const realizado = d[key];
                    const meta = d[metric.goalKey];
                    const percent = meta > 0 ? realizado / meta : 0;
                    const colorClass = getPerfColor(percent);
                    const lastWeekUnit = fullDataLastWeek.find(u => u.Clínica === d.Clínica);
                    const lastWeekValue = lastWeekUnit ? lastWeekUnit[key] : null;
                    bestHtml += `<div class="border-b border-gray-700/50 pb-2">
                                    <div class="flex justify-between items-center">
                                        <span class="truncate">${i+1}. ${d.Clínica}</span> 
                                        <div class="flex items-baseline justify-end">
                                            <strong class="text-lg ${colorClass}">${formatNumber(realizado)}</strong>
                                            ${getComparisonVsLastWeekHTML(realizado, lastWeekValue, formatNumber)}
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-500 text-right">${formatPercent(percent, 0)} de ${formatNumber(meta)}</div>
                                 </div>`;
                });
                bestHtml += `</div></div>`;

                // Bottom 10 by percentage of goal achieved
                const bottom10 = [...data].filter(d => d[metric.goalKey] > 0).sort((a, b) => (a[key]/a[metric.goalKey]) - (b[key]/b[metric.goalKey])).slice(0, 10);
                worstHtml += `<div class="bg-black/20 p-4 rounded-lg">
                                <h4 class="font-bold mb-3 text-center">${metric.title}</h4>
                                <div class="text-sm space-y-3">`;
                bottom10.forEach((d, i) => {
                    const realizado = d[key];
                    const meta = d[metric.goalKey];
                    const percent = meta > 0 ? realizado / meta : 0;
                    const colorClass = getPerfColor(percent);
                    const lastWeekUnit = fullDataLastWeek.find(u => u.Clínica === d.Clínica);
                    const lastWeekValue = lastWeekUnit ? lastWeekUnit[key] : null;
                     worstHtml += `<div class="border-b border-gray-700/50 pb-2">
                                    <div class="flex justify-between items-center">
                                        <span class="truncate">${i+1}. ${d.Clínica}</span> 
                                        <div class="flex items-baseline justify-end">
                                            <strong class="text-lg ${colorClass}">${formatNumber(realizado)}</strong>
                                            ${getComparisonVsLastWeekHTML(realizado, lastWeekValue, formatNumber)}
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-500 text-right">${formatPercent(percent, 0)} de ${formatNumber(meta)}</div>
                                 </div>`;
                });
                worstHtml += `</div></div>`;
            }

            bestPerformersContainer.innerHTML = bestHtml;
            worstPerformersContainer.innerHTML = worstHtml;
            
            // Gerar Análises de IA
            (async () => {
                const bestAIContainer = document.getElementById('best-performers-ai');
                bestAIContainer.innerHTML = `<div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full bg-green-400 animate-pulse"></div> <span>Analisando destaques...</span></div>`;
                const topPerformersSummary = Object.keys(metricDetails).map(m_key => {
                    const topUnit = data.reduce((prev, current) => (prev[m_key] > current[m_key]) ? prev : current);
                    return `${metricDetails[m_key].title}: ${topUnit.Clínica} com ${formatNumber(topUnit[m_key])}`;
                }).join('; ');
                const bestPrompt = `Analise os destaques de performance da rede de clínicas: ${topPerformersSummary}. Identifique padrões ou pontos fortes comuns entre as líderes e forneça um insight estratégico conciso sobre o que a rede pode aprender com essas unidades.`;
                bestAIContainer.innerHTML = await generateAIAnalysis(bestPrompt);

                const worstAIContainer = document.getElementById('worst-performers-ai');
                 worstAIContainer.innerHTML = `<div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full bg-red-400 animate-pulse"></div> <span>Analisando pontos de melhoria...</span></div>`;
                const worstPerformersSummary = Object.keys(metricDetails).map(m_key => {
                     const worstUnit = data.filter(d => d[metricDetails[m_key].goalKey] > 0).reduce((prev, current) => ((prev[m_key]/prev[metricDetails[m_key].goalKey]) < (current[m_key]/current[metricDetails[m_key].goalKey])) ? prev : current);
                    return `Pior performance em ${metricDetails[m_key].title}: ${worstUnit.Clínica} com ${formatPercent(worstUnit[m_key]/worstUnit[metricDetails[m_key].goalKey])}`;
                }).join('; ');
                 const worstPrompt = `Analise os pontos de maior fragilidade da rede de clínicas: ${worstPerformersSummary}. Identifique um possível problema central que afeta essas unidades com baixo desempenho e forneça uma recomendação estratégica concisa para iniciar a recuperação.`;
                worstAIContainer.innerHTML = await generateAIAnalysis(worstPrompt);
            })();
        }

        async function renderConversionRankings(data) {
            const container = document.getElementById('conversion-rankings');
            if (!data || data.length === 0) {
                container.innerHTML = "";
                return;
            }
            
            const conversionMetrics = [
                { key: 'conv_la', title: 'Leads → Agend.' },
                { key: 'conv_ac', title: 'Agend. → Comp.' },
                { key: 'conv_cf', title: 'Comp. → Fech.' },
                { key: 'conv_lf', title: 'Leads → Fech.' },
            ];
            
            const getRateColor = (rate, median) => {
                const diff = rate / median;
                if (diff >= 1) return 'text-green-400';
                if (diff >= 0.7) return 'text-yellow-400';
                return 'text-red-400';
            }

            let html = `
            <div class="dashboard-card">
                 <h2 class="text-2xl font-bold text-[--text-primary] mb-4">📊 Rankings de Taxas de Conversão</h2>
                 <!-- MELHORES TAXAS -->
                 <div>
                    <h3 class="text-xl font-semibold text-green-400 mb-4">⭐ Melhores Taxas</h3>
                    <p class="text-sm text-[--text-secondary] -mt-3 mb-4">Classifica as unidades com as taxas de conversão mais altas em cada etapa do funil, mostrando quem é mais eficiente.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="best-rates"></div>
                    <div id="best-rates-ai" class="mt-6 p-4 bg-black/20 rounded-lg"></div>
                 </div>
                 <hr class="border-t border-[--border-color] my-8">
                 <!-- PIORES TAXAS -->
                 <div>
                    <h3 class="text-xl font-semibold text-red-400 mb-4">📉 Piores Taxas</h3>
                    <p class="text-sm text-[--text-secondary] -mt-3 mb-4">Classifica as unidades com as taxas de conversão mais baixas em cada etapa do funil, mostrando os maiores gargalos.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="worst-rates"></div>
                    <div id="worst-rates-ai" class="mt-6 p-4 bg-black/20 rounded-lg"></div>
                 </div>
            </div>`;
            container.innerHTML = html;

            const bestRatesContainer = document.getElementById('best-rates');
            const worstRatesContainer = document.getElementById('worst-rates');

            let bestHtml = '';
            let worstHtml = '';

            for (const metric of conversionMetrics) {
                const medianRate = medians[metric.key];

                // Top 10
                const top10 = [...data].filter(d => d[metric.key] > 0).sort((a, b) => b[metric.key] - a[metric.key]).slice(0, 10);
                bestHtml += `<div class="bg-black/20 p-4 rounded-lg">
                                <h4 class="font-bold mb-3 text-center">${metric.title}</h4>
                                <div class="text-sm space-y-2">`;
                top10.forEach((d, i) => {
                    const rate = d[metric.key];
                    const colorClass = getRateColor(rate, medianRate);
                    const lastWeekUnit = fullDataLastWeek.find(u => u.Clínica === d.Clínica);
                    const lastWeekRate = lastWeekUnit ? lastWeekUnit[metric.key] : null;
                    bestHtml += `<div class="flex justify-between border-b border-gray-700/50 pb-1">
                                    <span class="truncate">${i+1}. ${d.Clínica}</span> 
                                    <div class="flex items-baseline">
                                        <strong class="${colorClass}">${formatPercent(rate)}</strong>
                                        ${getComparisonVsLastWeekHTML(rate, lastWeekRate, formatPercent)}
                                    </div>
                                 </div>`;
                });
                bestHtml += `</div></div>`;

                // Bottom 10
                const bottom10 = [...data].filter(d => d[metric.key] > 0).sort((a, b) => a[metric.key] - b[metric.key]).slice(0, 10);
                worstHtml += `<div class="bg-black/20 p-4 rounded-lg">
                                <h4 class="font-bold mb-3 text-center">${metric.title}</h4>
                                <div class="text-sm space-y-2">`;
                bottom10.forEach((d, i) => {
                    const rate = d[metric.key];
                    const colorClass = getRateColor(rate, medianRate);
                    const lastWeekUnit = fullDataLastWeek.find(u => u.Clínica === d.Clínica);
                    const lastWeekRate = lastWeekUnit ? lastWeekUnit[metric.key] : null;
                    worstHtml += `<div class="flex justify-between border-b border-gray-700/50 pb-1">
                                     <span class="truncate">${i+1}. ${d.Clínica}</span> 
                                     <div class="flex items-baseline">
                                        <strong class="${colorClass}">${formatPercent(rate)}</strong>
                                        ${getComparisonVsLastWeekHTML(rate, lastWeekRate, formatPercent)}
                                     </div>
                                  </div>`;
                });
                worstHtml += `</div></div>`;
            }

            bestRatesContainer.innerHTML = bestHtml;
            worstRatesContainer.innerHTML = worstHtml;

            // Gerar Análises de IA
            (async () => {
                const bestAIContainer = document.getElementById('best-rates-ai');
                bestAIContainer.innerHTML = `<div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full bg-green-400 animate-pulse"></div> <span>Analisando taxas de destaque...</span></div>`;
                const topRatesSummary = conversionMetrics.map(m => {
                    const topUnit = data.reduce((prev, current) => (prev[m.key] > current[m.key]) ? prev : current);
                    return `Melhor em ${m.title}: ${topUnit.Clínica} com ${formatPercent(topUnit[m.key])}`;
                }).join('; ');
                const bestPrompt = `Analise as melhores taxas de conversão da rede: ${topRatesSummary}. Identifique se existe alguma unidade que se destaca consistentemente em múltiplas etapas do funil e sugira qual processo dela poderia ser replicado como um modelo para as demais.`;
                bestAIContainer.innerHTML = await generateAIAnalysis(bestPrompt);

                const worstAIContainer = document.getElementById('worst-rates-ai');
                worstAIContainer.innerHTML = `<div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full bg-red-400 animate-pulse"></div> <span>Analisando gargalos de conversão...</span></div>`;
                const worstRatesSummary = conversionMetrics.map(m => {
                    const worstUnit = data.filter(d => d[m.key] > 0).reduce((prev, current) => (prev[m.key] < current[m.key]) ? prev : current);
                    return `Pior em ${m.title}: ${worstUnit.Clínica} com ${formatPercent(worstUnit[m.key])}`;
                }).join('; ');
                const worstPrompt = `Analise as piores taxas de conversão da rede: ${worstRatesSummary}. Identifique o gargalo mais comum (a etapa com as piores taxas em geral) e sugira uma ação prioritária para corrigir esse problema em toda a rede.`;
                worstAIContainer.innerHTML = await generateAIAnalysis(worstPrompt);
            })();
        }

        function renderGapsSection(unit) {
            const container = document.getElementById('unit-gaps-section');
            if (!container) return;
            
            const unitLastWeek = fullDataLastWeek.find(u => u.Clínica === unit.Clínica);

            const gapFaturamento = Math.max(0, unit.meta_sazonal - unit.revenue);
            const gapAgendamentos = Math.max(0, unit.meta_agends - unit.agends);
            const gapFechamentos = Math.max(0, unit.meta_closes - unit.closes);

            const gapFaturamentoLastWeek = unitLastWeek ? Math.max(0, unitLastWeek.meta_sazonal - unitLastWeek.revenue) : null;
            const gapAgendamentosLastWeek = unitLastWeek ? Math.max(0, unitLastWeek.meta_agends - unitLastWeek.agends) : null;
            const gapFechamentosLastWeek = unitLastWeek ? Math.max(0, unitLastWeek.meta_closes - unitLastWeek.closes) : null;


            const hasGaps = gapFaturamento > 0 || gapAgendamentos > 0 || gapFechamentos > 0;

            if (!hasGaps) {
                container.innerHTML = '';
                return;
            }

            let html = `
            <div class="dashboard-card">
                <h2 class="text-xl font-bold text-[--text-primary] mb-4">🏁 Gaps para Atingir a Meta Mensal</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-black/20 p-4 rounded-lg text-center">
                        <h3 class="text-sm font-semibold text-[--text-secondary]">Faturamento Restante</h3>
                        <p class="text-3xl font-bold text-yellow-400 flex items-baseline justify-center">${formatCurrency(gapFaturamento)} ${getComparisonVsLastWeekHTML(gapFaturamento, gapFaturamentoLastWeek, formatCurrency, true)}</p>
                        <p class="text-xs text-gray-500">Meta: ${formatCurrency(unit.meta_sazonal)}</p>
                    </div>
                    <div class="bg-black/20 p-4 rounded-lg text-center">
                        <h3 class="text-sm font-semibold text-[--text-secondary]">Agendamentos Restantes</h3>
                        <p class="text-3xl font-bold text-yellow-400 flex items-baseline justify-center">${formatNumber(gapAgendamentos)} ${getComparisonVsLastWeekHTML(gapAgendamentos, gapAgendamentosLastWeek, formatNumber, true)}</p>
                         <p class="text-xs text-gray-500">Meta: ${formatNumber(unit.meta_agends)}</p>
                    </div>
                    <div class="bg-black/20 p-4 rounded-lg text-center">
                        <h3 class="text-sm font-semibold text-[--text-secondary]">Fechamentos Restantes</h3>
                        <p class="text-3xl font-bold text-yellow-400 flex items-baseline justify-center">${formatNumber(gapFechamentos)} ${getComparisonVsLastWeekHTML(gapFechamentos, gapFechamentosLastWeek, formatNumber, true)}</p>
                         <p class="text-xs text-gray-500">Meta: ${formatNumber(unit.meta_closes)}</p>
                    </div>
                </div>
            </div>`;
            container.innerHTML = html;
        }
        
        async function renderRecoveryPriorities(data) {
            const container = document.getElementById('recovery-priorities-chart');
            const aiContainer = document.getElementById('recovery-ai-analysis');
            
            const underperformers = data.filter(d => d.online_revenue_gap > 0).sort((a,b) => b.online_revenue_gap - a.online_revenue_gap).slice(0, 10);
            
            if (underperformers.length > 0) {
                renderChart('recovery-priorities-chart', {
                  series: [{ name: 'Gap Online (R$)', data: underperformers.map(d => d.online_revenue_gap) }],
                  chart: { type: 'bar', height: 350, toolbar: { show: false } },
                  plotOptions: { bar: { borderRadius: 4, horizontal: true } },
                  dataLabels: { enabled: true, formatter: val => formatCurrency(val), style: { colors: ['#c9d1d9'] }, offsetX: -10 },
                  xaxis: { categories: underperformers.map(d => d.Clínica) },
                  colors: ['var(--red)'],
                });

                aiContainer.innerHTML = `<div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full bg-red-400 animate-pulse"></div> <span>Analisando cenários de recuperação...</span></div>`;
                const criticalSummary = underperformers.slice(0,3).map(d => `${d.Clínica} (falta ${formatCurrency(d.online_revenue_gap)})`).join(', ');
                const prompt = `As 3 unidades mais críticas em faturamento online são: ${criticalSummary}. Com base nesse gap financeiro, sugira uma ação emergencial e de alto impacto que a agência possa tomar para reverter rapidamente esse cenário, focando em otimização de campanha ou geração de leads qualificados.`;
                aiContainer.innerHTML = await generateAIAnalysis(prompt);

            } else { 
                container.innerHTML = '<p class="text-center py-4 text-gray-500">Nenhuma unidade com gap de faturamento online para exibir.</p>';
                aiContainer.innerHTML = "";
            }
        }
        
        function renderRadarChart(unit) {
            const categories = ['L→A', 'A→C', 'C→F', 'TKM Online', 'R$/Lead'];
            const unitData = [
                unit.conv_la / medians.conv_la, unit.conv_ac / medians.conv_ac, unit.conv_cf / medians.conv_cf,
                unit.tkm_online / medians.tkm_online, (medians.rpl > 0 ? unit.rpl / medians.rpl : 0)
            ].map(v => isFinite(v) ? parseFloat(v.toFixed(2)) : 0);
            const options = {
                series: [{
                    name: 'Unidade',
                    data: unitData
                }, {
                    name: 'Mediana da Rede',
                    data: [1, 1, 1, 1, 1]
                }],
                chart: {
                    height: 350,
                    type: 'radar',
                    toolbar: { show: false }
                },
                xaxis: {
                    categories: categories
                },
                yaxis: {
                    show: false
                },
                stroke: {
                    width: 2
                },
                fill: {
                    opacity: 0.25
                },
                markers: {
                    size: 4
                }
            };
            renderChart('radar-chart-container', options);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorSection.classList.remove('hidden');
        }

        function hideError() {
            errorSection.classList.add('hidden');
        }

        function renderChart(element, options) {
            const container = typeof element === 'string' ? document.getElementById(element) : element;
            if (!container) return;
            const chartId = container.id || `chart-${Math.random()}`;
            container.innerHTML = '';
            if (activeCharts[chartId] && typeof activeCharts[chartId].destroy === 'function') {
                activeCharts[chartId].destroy();
            }
            if (options) {
                // Adiciona configurações de tema escuro a todos os gráficos
                const darkThemeOptions = {
                    chart: { background: 'transparent', ...options.chart },
                    tooltip: { theme: 'dark', ...options.tooltip },
                    xaxis: { ...options.xaxis, labels: { style: { colors: 'var(--text-secondary)' } }, title: { style: { color: 'var(--text-secondary)' } } },
                    yaxis: { ...options.yaxis, labels: { style: { colors: 'var(--text-secondary)' } }, title: { style: { color: 'var(--text-secondary)' } } },
                    legend: { ...options.legend, labels: { colors: 'var(--text-primary)' } },
                    grid: { borderColor: 'var(--border-color)' }
                };
                
                const finalOptions = {...options, ...darkThemeOptions};
                
                const chart = new ApexCharts(container, finalOptions);
                chart.render().catch(e => console.error(`Error rendering chart ${chartId}:`, e));
                activeCharts[chartId] = chart;
            } else {
                container.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500 p-8">Sem dados para exibir o gráfico.</div>`;
            }
        }

        function createFunnelHTML(data, originalData = null, lastWeekData = null) {
             const getArrowClass = (value, threshold) => value >= threshold ? 'green' : 'orange';
             const conversions = {
                la: data.leads > 0 ? data.agends / data.leads : 0,
                ac: data.agends > 0 ? data.compares / data.agends : 0,
                cf: data.compares > 0 ? data.closes / data.compares : 0,
            };
            
            const createDiffSpan = (current, original) => {
                if (original === null || original === undefined) return '';
                const diff = current - original;
                if (diff > 0) {
                    return `<span class="text-sm font-medium text-green-400 ml-2">(+${formatNumber(diff)})</span>`;
                }
                return '';
            };
            
            const createLastWeekSpan = (current, last) => {
                if(last === null || last === undefined || last === current) return '';
                const diff = current - last;
                const color = diff >= 0 ? 'text-green-300' : 'text-red-300';
                const sign = diff > 0 ? '+' : '';
                return `<span class="text-xs font-normal ${color}">(${sign}${formatNumber(diff)})</span>`;
            }


            return `
                <div class="funnel">
                    <div class="funnel-stage contatos">
                        <div class="stage-title">Leads</div>
                        <div class="stage-value">${formatNumber(data.leads)} ${createDiffSpan(data.leads, originalData?.leads)} ${createLastWeekSpan(data.leads, lastWeekData?.leads)}</div>
                    </div>
                    <div class="conversion-arrow ${getArrowClass(conversions.la, 0.4)}">
                        <span class="arrow-icon">↓</span> <span class="conv-text">${formatPercent(conversions.la)}</span>
                    </div>
                    <div class="funnel-stage agendamentos">
                        <div class="stage-title">Agendamentos</div>
                        <div class="stage-value">${formatNumber(data.agends)} ${createDiffSpan(data.agends, originalData?.agends)} ${createLastWeekSpan(data.agends, lastWeekData?.agends)}</div>
                    </div>
                    <div class="conversion-arrow ${getArrowClass(conversions.ac, 0.6)}">
                        <span class="arrow-icon">↓</span> <span class="conv-text">${formatPercent(conversions.ac)}</span>
                    </div>
                    <div class="funnel-stage comparecimentos">
                        <div class="stage-title">Comparecimentos</div>
                        <div class="stage-value">${formatNumber(data.compares)} ${createDiffSpan(data.compares, originalData?.compares)} ${createLastWeekSpan(data.compares, lastWeekData?.compares)}</div>
                    </div>
                    <div class="conversion-arrow ${getArrowClass(conversions.cf, 0.3)}">
                        <span class="arrow-icon">↓</span> <span class="conv-text">${formatPercent(conversions.cf)}</span>
                    </div>
                    <div class="funnel-stage fechamentos">
                        <div class="stage-title">Fechamentos</div>
                        <div class="stage-value">${formatNumber(data.closes)} ${createDiffSpan(data.closes, originalData?.closes)} ${createLastWeekSpan(data.closes, lastWeekData?.closes)}</div>
                    </div>
                </div>
            `;
        }

        function renderFunnelAndSimulator(unit) {
            const unitLastWeek = fullDataLastWeek.find(u => u.Clínica === unit.Clínica);
            const funnelHTML = createFunnelHTML(unit, null, unitLastWeek);

            let html = `
            <div class="dashboard-card mb-8">
                <h2 class="text-2xl font-bold text-[--text-primary] mb-4">🔬 Análise de Funil e Mídia Paga: ${unit.Clínica}</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-4 text-center">Funil de Vendas Online</h3>
                        ${funnelHTML}
                    </div>
                    <div class="p-4 bg-black/20 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4">📈 Análise de Mídia Paga</h3>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-medium">Investimento Google (R$)</label><input type="number" id="sim-google-invest" placeholder="Ex: 5000.00" class="w-full"></div>
                            <div><label class="block text-sm font-medium">Custo por Lead Google (R$)</label><input type="number" id="sim-google-cpl" placeholder="Ex: 50.00" class="w-full"></div>
                            <div><label class="block text-sm font-medium">Investimento Facebook (R$)</label><input type="number" id="sim-fb-invest" placeholder="Ex: 3000.00" class="w-full"></div>
                             <div><label class="block text-sm font-medium">Custo por Lead Facebook (R$)</label><input type="number" id="sim-fb-cpl" placeholder="Ex: 40.00" class="w-full"></div>
                        </div>
                        <div class="mt-6">
                            <button id="analyze-paid-media" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[--blue] hover:bg-blue-600 focus:outline-none">
                                Gerar Análise e Projeção
                            </button>
                        </div>
                        <div id="ai-paid-media-analysis" class="mt-6 p-4 bg-black/30 rounded-lg border border-[--border-color] min-h-[100px]">
                            <p class="text-sm text-gray-500">Insira os dados de investimento e CPL para obter uma análise detalhada e uma projeção de funil da IA.</p>
                        </div>
                    </div>
                </div>
                 <div id="paid-media-charts-container" class="mt-8 grid-cols-1 md:grid-cols-2 gap-8 hidden"></div>
                 <div id="projected-funnel-container" class="mt-8 hidden"></div>
            </div>`;
            funnelAnalysisSection.innerHTML = html;
            
            document.getElementById('analyze-paid-media').addEventListener('click', () => generatePaidMediaAIAnalysis(unit));
        }
        
        async function generatePaidMediaAIAnalysis(unit) {
            const container = document.getElementById('ai-paid-media-analysis');
            if (!container) return;

            const googleInvest = parseFloat(document.getElementById('sim-google-invest').value) || 0;
            const googleCPL = parseFloat(document.getElementById('sim-google-cpl').value) || 0;
            const fbInvest = parseFloat(document.getElementById('sim-fb-invest').value) || 0;
            const fbCPL = parseFloat(document.getElementById('sim-fb-cpl').value) || 0;
            const totalInvest = googleInvest + fbInvest;
            
            if (totalInvest === 0) {
                container.innerHTML = `<p class="text-sm text-yellow-400">Por favor, insira pelo menos um valor de investimento para gerar a análise.</p>`;
                return;
            }
            
            container.innerHTML = `<div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full bg-blue-400 animate-pulse"></div> <span>Analisando dados de mídia paga...</span></div>`;

            const prompt = `Aja como um especialista em tráfego pago para clínicas odontológicas. A unidade "${unit.Clínica}" teve os seguintes resultados no funil: ${unit.leads} leads, ${unit.closes} fechamentos, e um TKM online de ${formatCurrency(unit.tkm_online)}. Os dados de investimento foram: Google Ads = ${formatCurrency(googleInvest)} com CPL de ${formatCurrency(googleCPL)}; Facebook Ads = ${formatCurrency(fbInvest)} com CPL de ${formatCurrency(fbCPL)}. Com base nestes dados, forneça uma análise concisa sobre: 1. A saúde do CPL de cada plataforma em relação ao TKM. 2. Qual plataforma parece mais eficiente em termos de custo-benefício. 3. Uma recomendação estratégica (ex: mover orçamento, otimizar uma plataforma, etc.).`;

            const analysis = await generateAIAnalysis(prompt);
            container.innerHTML = analysis;
            
            renderPaidMediaCharts(unit, { googleInvest, fbInvest, totalInvest });
            generateProjectedFunnelAI(unit, { googleInvest, googleCPL, fbInvest, fbCPL });
        }

        function renderPaidMediaCharts(unit, investmentData) {
            const container = document.getElementById('paid-media-charts-container');
            if (!container) return;

            container.classList.replace('hidden', 'grid');

            // --- CAC Chart ---
            const cac = unit.closes > 0 ? investmentData.totalInvest / unit.closes : 0;
            const cacCardHTML = `
            <div class="dashboard-card">
                <h2 class="text-xl font-bold text-[--text-primary]">📈 CAC (Custo por Aquisição)</h2>
                <div class="text-center mt-4">
                    <p class="text-4xl font-bold ${cac > 0 && cac < unit.tkm_online ? 'text-green-400' : 'text-red-400'}">${formatCurrency(cac)}</p>
                    <p class="text-sm text-[--text-secondary] mt-2">TKM Online: ${formatCurrency(unit.tkm_online)}</p>
                </div>
            </div>`;

            // --- Daily Revenue Chart ---
            const businessDays = 21; // Assuming August 2025
            const dailyAvgRevenue = unit.revenue / businessDays;
            const dailyRevenueCardHTML = `
             <div class="dashboard-card">
                <h2 class="text-xl font-bold text-[--text-primary]">📅 Média de Faturamento Diário</h2>
                <div class="text-center mt-4">
                     <p class="text-4xl font-bold text-blue-300">${formatCurrency(dailyAvgRevenue)}</p>
                     <p class="text-sm text-[--text-secondary] mt-2">Baseado em ${businessDays} dias úteis (Agosto/2025)</p>
                </div>
            </div>`;

            container.innerHTML = cacCardHTML + dailyRevenueCardHTML;
        }
        
        async function generateProjectedFunnelAI(unit, investmentData) {
            const container = document.getElementById('projected-funnel-container');
            if (!container) return;
            
            container.classList.remove('hidden');
            container.innerHTML = `<h3 class="text-lg font-semibold mb-4 text-center">Projeção de Funil com Investimento Otimizado (IA)</h3>
                                   <div class="flex items-center justify-center space-x-2"><div class="w-4 h-4 rounded-full bg-blue-400 animate-pulse"></div> <span>Gerando projeção...</span></div>`;
            
            const schema = {
                type: "OBJECT",
                properties: {
                    suggested_investment: { type: "NUMBER", description: "Valor total do investimento otimizado sugerido." },
                    projected_leads: { type: "NUMBER", description: "Número de leads que o investimento otimizado deve gerar." },
                    google_investment: { type: "NUMBER", description: "Parte do investimento sugerido para Google Ads." },
                    facebook_investment: { type: "NUMBER", description: "Parte do investimento sugerido para Facebook Ads." },
                    reasoning: { type: "STRING", description: "Breve justificativa para a distribuição do investimento sugerido." }
                },
                required: ["suggested_investment", "projected_leads", "google_investment", "facebook_investment", "reasoning"]
            };

            const prompt = `Aja como um estratega de mídia sênior. Para a clínica "${unit.Clínica}", que tem uma conversão L->F de ${formatPercent(unit.conv_lf)} e TKM de ${formatCurrency(unit.tkm_online)}, o investimento informado foi de ${formatCurrency(investmentData.googleInvest + investmentData.fbInvest)}. Com base em benchmarks do setor odontológico no Brasil e concorrência local, sugira um investimento total otimizado para o próximo mês para maximizar o ROI. Forneça também o número de leads que este novo investimento provavelmente geraria e a distribuição de investimento sugerida entre Google Ads e Facebook Ads, com uma breve justificativa para essa distribuição.`;

            const result = await generateStructuredAIAnalysis(prompt, schema);

            if (result && result.projected_leads) {
                const projectedData = {
                    leads: result.projected_leads,
                    agends: Math.round(result.projected_leads * unit.conv_la),
                    compares: Math.round(result.projected_leads * unit.conv_la * unit.conv_ac),
                    closes: Math.round(result.projected_leads * unit.conv_la * unit.conv_ac * unit.conv_cf)
                };
                const projectedFunnelHTML = createFunnelHTML(projectedData, unit); // Passando 'unit' como originalData
                
                const investmentDetailsHTML = `
                    <div class="p-4 bg-black/20 rounded-lg mb-4">
                        <h4 class="font-bold text-blue-300">Plano de Investimento Sugerido</h4>
                        <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                             <div>
                                <p class="text-sm text-[--text-secondary]">Google Ads</p>
                                <p class="text-xl font-bold">${formatCurrency(result.google_investment)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-[--text-secondary]">Facebook Ads</p>
                                <p class="text-xl font-bold">${formatCurrency(result.facebook_investment)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-[--text-secondary]">Total Sugerido</p>
                                <p class="text-xl font-bold text-green-400">${formatCurrency(result.suggested_investment)}</p>
                            </div>
                        </div>
                        <p class="text-xs text-[--text-secondary] mt-4"><strong>Justificativa:</strong> ${result.reasoning || 'N/A'}</p>
                    </div>
                `;

                container.innerHTML = `<h3 class="text-lg font-semibold mb-4 text-center">Projeção com Investimento Otimizado (IA)</h3>${investmentDetailsHTML}${projectedFunnelHTML}`;
            } else {
                 container.innerHTML = `<h3 class="text-lg font-semibold mb-4 text-center">Projeção de Funil (IA)</h3><p class="text-sm text-yellow-400 text-center">Não foi possível gerar a projeção otimizada. Tente novamente.</p>`;
            }
        }
        
        function renderPlaybook(unit) {
            const playbooks = {
                'Leads → Agend.': {
                    title: 'Otimizar L→A',
                    emoji: '📞',
                    actions: ['Reduzir o tempo de primeiro contato (SLA < 5 minutos).', 'Revisar scripts de abordagem, focando em benefícios e urgência.', 'Implementar réguas de contato via WhatsApp com lembretes automáticos.']
                },
                'Agend. → Comp.': {
                    title: 'Otimizar A→C',
                    emoji: '🗓️',
                    actions: ['Enviar lembretes de consulta 48h e 24h antes via WhatsApp.', 'Realizar ligação de confirmação no dia anterior à consulta.', 'Oferecer opções de reagendamento fáceis caso o paciente precise.']
                },
                'Comp. → Fech.': {
                    title: 'Otimizar C→F',
                    emoji: '✍️',
                    actions: ['Revisar a apresentação da proposta de valor e condições de pagamento.', 'Treinar a equipe em técnicas de negociação e quebra de objeções.', 'Implementar follow-up estruturado (24-48h) para pacientes que não fecharam na hora.']
                }
            };
            const playbook = playbooks[unit.worst_stage] || {
                title: 'Nenhum gargalo crítico',
                emoji: '✅',
                actions: ['Continue monitorando todas as etapas do funil.']
            };
            let html = `
            <div class="dashboard-card">
                <h2 class="text-2xl font-bold text-[--text-primary] mb-4">${playbook.emoji} Playbook de Ação Rápida: ${unit.Clínica}</h2>
                <div class="bg-black/20 p-4 rounded-lg"><h3 class="font-semibold text-lg text-green-400">${playbook.title}</h3><ul class="list-disc list-inside mt-2 space-y-1 text-[--text-secondary]">${playbook.actions.map(action => `<li>${action}</li>`).join('')}</ul></div>
            </div>`;
            playbooksSection.innerHTML = html;
        }

        function getComparisonVsBenchmark(value, benchmark) {
            if (benchmark === 0 || !isFinite(benchmark) || !isFinite(value)) return {
                text: 'N/A',
                color: 'text-gray-500'
            };
            const diff = (value / benchmark) - 1;
            if (Math.abs(diff) <= 0.05) return {
                text: `~ Mediana (${formatPercent(benchmark)})`,
                color: 'text-yellow-400'
            };
            if (diff > 0) return {
                text: `⬆️ ${formatPercent(diff)} vs Mediana`,
                color: 'text-green-400'
            };
            return {
                text: `⬇️ ${formatPercent(Math.abs(diff))} vs Mediana`,
                color: 'text-red-400'
            };
        }

        function renderDataHygiene(data) {
            const highConvLA = data.filter(d => d.conv_la > 1);
            const zeroDenominator = data.filter(d => (d.leads > 0 && d.agends === 0) || (d.agends > 0 && d.compares === 0) || (d.compares > 0 && d.closes === 0));
            if (highConvLA.length > 0 || zeroDenominator.length > 0) {
                dataHygieneBanner.classList.remove('hidden');
                let message = `<strong>⚠️ Alerta de Qualidade de Dados:</strong>`;
                if (highConvLA.length > 0) message += ` ${highConvLA.length} unidade(s) com conversão L→A > 100%. <span class="font-normal text-sm block">Isso geralmente ocorre quando agendamentos de meses anteriores são marcados neste mês, ou por erros de lançamento.</span>`;
                if (zeroDenominator.length > 0) message += ` ${zeroDenominator.length} unidade(s) com etapas zeradas no funil, impactando o cálculo.`;
                dataHygieneBanner.innerHTML = `<div class="bg-yellow-900/50 border-l-4 border-yellow-500 text-yellow-300 p-4" role="alert"><p>${message}</p></div>`;
            } else {
                dataHygieneBanner.classList.add('hidden');
            }
        }

        function renderLeversTable(data) {
            const underperformers = data.filter(d => d.online_revenue_gap > 0).sort((a, b) => b.online_revenue_gap - a.online_revenue_gap);
            const container = document.getElementById('levers-table');
            if (underperformers.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhuma unidade com gap de faturamento online para exibir.</p>';
                return;
            }
             const add_closes_for_online_gap = (d) => {
                return d.tkm_online > 0 ? Math.ceil(d.online_revenue_gap / d.tkm_online) : 0;
            };
            const add_compares_for_online_gap = (d) => {
                const neededCloses = add_closes_for_online_gap(d);
                return medians.conv_cf > 0 ? Math.ceil(neededCloses / medians.conv_cf) : 0;
            };
            const add_agends_for_online_gap = (d) => {
                const neededCompares = add_compares_for_online_gap(d);
                return medians.conv_ac > 0 ? Math.ceil(neededCompares / medians.conv_ac) : 0;
            };
            const add_leads_for_online_gap = (d) => {
                const neededAgends = add_agends_for_online_gap(d);
                return medians.conv_la > 0 ? Math.ceil(neededAgends / medians.conv_la) : 0;
            };

            let tableHTML = `<table class="min-w-full divide-y divide-[--border-color]"><thead class="bg-black/20"><tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-[--text-secondary] uppercase">Clínica</th><th class="px-4 py-3 text-left text-xs font-medium text-[--text-secondary] uppercase">% Meta Online</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-[--text-secondary] uppercase">Gap Online (R$)</th><th class="px-4 py-3 text-left text-xs font-medium text-[--text-secondary] uppercase">+ Leads</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-[--text-secondary] uppercase">+ Agend.</th><th class="px-4 py-3 text-left text-xs font-medium text-[--text-secondary] uppercase">+ Comp.</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-[--text-secondary] uppercase">+ Fech.</th></tr></thead><tbody class="divide-y divide-[--border-color]">`;
           
            underperformers.forEach(d => {
                const pct_meta_online = d.meta_sazonal > 0 ? d.revenue_online / d.meta_sazonal : 0;
                tableHTML += `<tr>
                    <td class="px-4 py-4 text-sm font-medium text-[--text-primary]">${d.Clínica}</td>
                    <td class="px-4 py-4 text-sm text-red-400 font-semibold">${formatPercent(pct_meta_online)}</td>
                    <td class="px-4 py-4 text-sm text-[--text-secondary]">${formatCurrency(d.online_revenue_gap)}</td>
                    <td class="px-4 py-4 text-sm text-[--text-primary] font-bold">${formatNumber(add_leads_for_online_gap(d))}</td>
                    <td class="px-4 py-4 text-sm text-[--text-primary] font-bold">${formatNumber(add_agends_for_online_gap(d))}</td>
                    <td class="px-4 py-4 text-sm text-[--text-primary] font-bold">${formatNumber(add_compares_for_online_gap(d))}</td>
                    <td class="px-4 py-4 text-sm text-[--text-primary] font-bold">${formatNumber(add_closes_for_online_gap(d))}</td>
                </tr>`;
            });
            container.innerHTML = tableHTML + '</tbody></table>';
        }

        function renderPriorityAndBottleneck(data) {
            const container = document.getElementById('bottleneck-chart')?.parentElement;
            if(!container) return;

            const underperformers = data.filter(d => d.under70 && d.Clínica);

            const bottleneckCounts = underperformers.reduce((acc, clinic) => {
                if (clinic.worst_stage !== 'N/A') {
                    acc[clinic.worst_stage] = (acc[clinic.worst_stage] || 0) + 1;
                }
                return acc;
            }, {});
            if (Object.keys(bottleneckCounts).length > 0) {
                renderChart('bottleneck-chart', {
                    series: Object.values(bottleneckCounts),
                    labels: Object.keys(bottleneckCounts),
                    chart: {
                        type: 'donut',
                        height: 350
                    },
                    colors: ['#F59E0B', '#EF4444', '#DC2626'],
                    legend: {
                        position: 'bottom'
                    },
                    plotOptions: {
                        pie: {
                            donut: {
                                labels: {
                                    show: true,
                                    total: { show: true, color: 'var(--text-secondary)'},
                                    value: { color: 'var(--text-primary)'},
                                    name: { color: 'var(--text-secondary)'}
                                }
                            }
                        }
                    }
                });
            } else {
                renderChart('bottleneck-chart', null);
            }
        }

        function renderConversionVsTkmChart(data) {
            // Seção removida conforme solicitado.
        }
        
        async function renderOnlineShareAnalysis(data) {
            const container = document.getElementById('online-share-container');
            if (!container) return;

            const getClassAndLabel = (share) => {
                if (share >= 0.6) return { label: 'Saudável', color: 'text-green-300 bg-green-800/50' };
                if (share >= 0.4) return { label: 'Atenção', color: 'text-yellow-300 bg-yellow-800/50' };
                return { label: 'Urgente', color: 'text-red-300 bg-red-800/50' };
            };

            const units = data
                .filter(d => d.revenue > 0)
                .map(d => ({ ...d, classification: getClassAndLabel(d.share_online) }))
                .sort((a, b) => a.share_online - b.share_online);

            if (units.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Sem dados para analisar o share online.</p>';
                return;
            }

            const topUnits = units.slice(0, 20);
            const remainingUnits = units.slice(20);

            const createUnitHTML = (unit) => `
                <div class="p-3 hover:bg-black/20">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-[--text-primary] truncate">${unit.Clínica}</p>
                        <div>
                            <span class="text-lg font-bold">${formatPercent(unit.share_online)}</span>
                            <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full ${unit.classification.color}">${unit.classification.label}</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Online: ${formatCurrency(unit.revenue_online)} / Total: ${formatCurrency(unit.revenue)}</p>
                </div>
            `;
            
            let html = '<div class="divide-y divide-[--border-color]">';
            topUnits.forEach(unit => {
                html += createUnitHTML(unit);
            });
            html += '</div>';

            if(remainingUnits.length > 0) {
                html += `
                    <details class="mt-4">
                        <summary class="cursor-pointer text-sm font-medium text-blue-400 hover:text-blue-300 text-center py-2">
                            Mostrar mais ${remainingUnits.length} unidades...
                        </summary>
                        <div class="divide-y divide-[--border-color] mt-2 border-t border-[--border-color]">
                            ${remainingUnits.map(createUnitHTML).join('')}
                        </div>
                    </details>
                `;
            }
            container.innerHTML = html;


            const aiContainer = document.getElementById('ai-online-share-explanation');
            aiContainer.innerHTML = `<div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full bg-blue-400 animate-pulse"></div> <span>Analisando share online...</span></div>`;
            const urgentCount = units.filter(u => u.classification.label === 'Urgente').length;
            const attentionCount = units.filter(u => u.classification.label === 'Atenção').length;
            const healthyCount = units.filter(u => u.classification.label === 'Saudável').length;
            const prompt = `Aja como um consultor de marketing estratégico para uma rede de clínicas odontológicas. Analisamos a dependência do faturamento vindo de mídia online e encontramos a seguinte distribuição: ${urgentCount} unidades em estado 'Urgente' (share online baixo), ${attentionCount} em 'Atenção' e ${healthyCount} 'Saudável' (share online alto). Com base nestes números, explique em um parágrafo curto (3-4 frases) a importância estratégica de ter um share de faturamento online saudável e qual o risco ou oportunidade que essa distribuição representa para a rede.`;
            aiContainer.innerHTML = "<strong>🤖 Análise Estratégica:</strong> " + await generateAIAnalysis(prompt);
        }

        async function renderComparativeAnalysis(unit, allData) {
            const container = document.getElementById('comparative-analysis-section');
            if (!container || !unit.state) {
                container.innerHTML = '<p class="text-sm text-gray-500">Não foi possível realizar a análise comparativa. Estado da unidade não identificado.</p>';
                return;
            }
            
            const neighbors = allData.filter(d => d.state === unit.state && d.Clínica !== unit.Clínica);
            
            if(neighbors.length === 0) {
                 container.innerHTML = '<h2 class="text-xl font-bold text-[--text-primary] mb-4">Análise Comparativa de Vizinhança</h2><p class="text-sm text-gray-500">Nenhuma outra unidade encontrada no mesmo estado para comparação.</p>';
                return;
            }

            let html = `<h2 class="text-xl font-bold text-[--text-primary] mb-4">Análise Comparativa (Estado: ${unit.state})</h2>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left">
                            <thead class="bg-black/20"><tr>
                                <th class="p-2">Métrica</th>
                                <th class="p-2 text-center text-blue-300">${unit.Clínica}</th>
                                <th class="p-2 text-center">Média Vizinhança</th>
                            </tr></thead><tbody>`;

            const avgNeighbor = (key) => neighbors.reduce((acc, n) => acc + n[key], 0) / neighbors.length;
            
            const metricsToCompare = {
                'Conv. L→A': { key: 'conv_la', format: (v) => formatPercent(v) },
                'Conv. A→C': { key: 'conv_ac', format: (v) => formatPercent(v) },
                'Conv. C→F': { key: 'conv_cf', format: (v) => formatPercent(v) },
                'TKM Online': { key: 'tkm_online', format: (v) => formatCurrency(v) },
                'Share Online': { key: 'share_online', format: (v) => formatPercent(v) },
            };
            
            const unitLastWeek = fullDataLastWeek.find(u => u.Clínica === unit.Clínica);

            for(const metricName in metricsToCompare) {
                const metricInfo = metricsToCompare[metricName];
                const unitValue = unit[metricInfo.key];
                const neighborValue = avgNeighbor(metricInfo.key);
                const isBetter = unitValue > neighborValue;
                const colorClass = isBetter ? 'text-green-400' : 'text-red-400';
                const lastWeekValue = unitLastWeek ? unitLastWeek[metricInfo.key] : null;

                html += `<tr class="border-b border-[--border-color]">
                            <td class="p-2">${metricName}</td>
                            <td class="p-2 text-center font-bold ${colorClass}">
                                <div class="flex items-baseline justify-center">
                                    <span>${metricInfo.format(unitValue)}</span>
                                    ${getComparisonVsLastWeekHTML(unitValue, lastWeekValue, metricInfo.format)}
                                </div>
                            </td>
                            <td class="p-2 text-center">${metricInfo.format(neighborValue)}</td>
                         </tr>`;
            }

            html += `</tbody></table></div><div id="comparative-ai-analysis" class="mt-4 p-4 bg-black/20 rounded-lg"></div>`;
            container.innerHTML = html;
            
            const aiContainer = document.getElementById('comparative-ai-analysis');
            aiContainer.innerHTML = `<div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full bg-blue-400 animate-pulse"></div> <span>Analisando vizinhança...</span></div>`;
            const comparisonSummary = Object.keys(metricsToCompare).map(key => `${key}: ${metricsToCompare[key].format(unit[metricsToCompare[key].key])} (média vizinhos: ${metricsToCompare[key].format(avgNeighbor(metricsToCompare[key].key))})`).join('; ');
            const prompt = `A unidade "${unit.Clínica}" no estado de ${unit.state} apresenta os seguintes resultados em comparação com suas vizinhas: ${comparisonSummary}. Com base nesses dados, identifique o principal ponto forte e o principal ponto fraco da unidade em relação à sua concorrência local. Sugira uma estratégia de mídia online e uma de mídia offline para explorar a oportunidade ou corrigir a deficiência.`;
            aiContainer.innerHTML = await generateAIAnalysis(prompt);
        }

        async function renderTeamComparison(data) {
            const container = document.getElementById('team-comparison-section');
            if (!data || data.length === 0) {
                container.innerHTML = "";
                return;
            }

            const teamDharsonClinics = [
                'barra mansa', 'são paulo - guaianases', 'são paulo - santo amaro', 'são paulo - vila mariana', 'são paulo - itaquera', 'volta redonda', 
                'belo horizonte - barreiro', 'contagem', 'belo horizonte - pampulha', 'bragança paulista', 'guaramirim', 'mafra', 'caçador', 'novo hamburgo', 
                'são joão da boa vista', 'rio claro', 'umuarama', 'mogi guaçu', 'belo horizonte - prado', 'belo horizonte - av. dom pedro ii', 'içara', 
                'goianésia', 'monte carmelo', 'sorocaba - itavuvu', 'alfenas', 'são paulo - vila mascote', 'sete lagoas', 'castanhal', 'itabaiana', 
                'fazenda rio grande', 'betim', 'santo andré - centro', 'montenegro', 'camaquã', 'belo horizonte - santa efigênia', 'araçatuba', 
                'ponta grossa', 'sertãozinho', 'ribeirão preto'
            ];
            
            const teamViniciusClinics = [
                'foz do iguaçu', 'ivaiporã', 'jacarezinho', 'lages', 'maracanaú', 'pitanga', 'santa cruz do rio pardo', 'sumaré', 'torres', 
                'juazeiro do norte', 'monte alto', 'caieiras', 'são joão del rei', 'cristalina', 'vitória da conquista', 'videira', 'amparo', 'jaguariúna', 
                'recife - derby', 'salvador - ondina', 'luis eduardo magalhães', 'caldas novas', 'teixeira de freitas', 'morrinhos', 'fernandópolis', 
                'colombo', 'pinhais', 'bauru', 'arapiraca', 'lauro de freitas', 'cornélio procópio', 'sarandi - rs', 'pirassununga', 'araraquara', 
                'joinville', 'uberlândia - santa mônica', 'maringá', 'paiçandu', 'mandaguari', 'jandaia do sul', 'leme'
            ];

            const normalizeClinicName = (name) => name ? name.toString().toLowerCase().trim() : '';

            const dharsonData = data.filter(d => teamDharsonClinics.includes(normalizeClinicName(d.Clínica)));
            const viniciusData = data.filter(d => teamViniciusClinics.includes(normalizeClinicName(d.Clínica)));
            const dharsonDataLastWeek = fullDataLastWeek.filter(d => teamDharsonClinics.includes(normalizeClinicName(d.Clínica)));
            const viniciusDataLastWeek = fullDataLastWeek.filter(d => teamViniciusClinics.includes(normalizeClinicName(d.Clínica)));

            const calculateTeamMetrics = (teamData) => {
                if (teamData.length === 0) return { faturamento: 0, leads: 0, fechamentos: 0, conversaoLF: 0, avgTKM: 0 };
                const faturamento = teamData.reduce((sum, d) => sum + d.revenue, 0);
                const leads = teamData.reduce((sum, d) => sum + d.leads, 0);
                const fechamentos = teamData.reduce((sum, d) => sum + d.closes, 0);
                const conversaoLF = leads > 0 ? fechamentos / leads : 0;
                const unitsWithTKM = teamData.filter(d => d.tkm_online > 0);
                const totalTKM = unitsWithTKM.reduce((sum, d) => sum + d.tkm_online, 0);
                const avgTKM = unitsWithTKM.length > 0 ? totalTKM / unitsWithTKM.length : 0;
                return { faturamento, leads, fechamentos, conversaoLF, avgTKM };
            };

            const dharsonMetrics = calculateTeamMetrics(dharsonData);
            const viniciusMetrics = calculateTeamMetrics(viniciusData);
            const dharsonMetricsLastWeek = calculateTeamMetrics(dharsonDataLastWeek);
            const viniciusMetricsLastWeek = calculateTeamMetrics(viniciusDataLastWeek);
            
            const assignedClinicNormalized = new Set([...teamDharsonClinics, ...teamViniciusClinics]);
            const unassignedUnits = data.filter(d => !assignedClinicNormalized.has(normalizeClinicName(d.Clínica)));

            const createTeamCardHTML = (teamName, metrics, lastWeekMetrics = {}) => {
                return `
                <div class="bg-black/20 p-4 rounded-lg flex-grow flex flex-col">
                    <h3 class="text-xl font-bold text-center mb-4">${teamName}</h3>
                    <div class="space-y-4 flex-grow flex flex-col justify-around">
                        <div class="text-center">
                            <p class="text-sm text-[--text-secondary]">Faturamento</p>
                            <p class="text-2xl font-bold text-green-400 flex items-baseline justify-center">${formatCurrency(metrics.faturamento)} ${getComparisonVsLastWeekHTML(metrics.faturamento, lastWeekMetrics.faturamento, formatCurrency)}</p>
                        </div>
                         <div class="text-center">
                            <p class="text-sm text-[--text-secondary]">Leads</p>
                            <p class="text-2xl font-bold flex items-baseline justify-center">${formatNumber(metrics.leads)} ${getComparisonVsLastWeekHTML(metrics.leads, lastWeekMetrics.leads, formatNumber)}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-[--text-secondary]">Fechamentos</p>
                            <p class="text-2xl font-bold flex items-baseline justify-center">${formatNumber(metrics.fechamentos)} ${getComparisonVsLastWeekHTML(metrics.fechamentos, lastWeekMetrics.fechamentos, formatNumber)}</p>
                        </div>
                         <div class="text-center">
                            <p class="text-sm text-[--text-secondary]">Ticket Médio</p>
                            <p class="text-2xl font-bold flex items-baseline justify-center">${formatCurrency(metrics.avgTKM)} ${getComparisonVsLastWeekHTML(metrics.avgTKM, lastWeekMetrics.avgTKM, formatCurrency)}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-[--text-secondary]">Conversão L→F</p>
                            <p class="text-2xl font-bold text-blue-300 flex items-baseline justify-center">${formatPercent(metrics.conversaoLF)} ${getComparisonVsLastWeekHTML(metrics.conversaoLF, lastWeekMetrics.conversaoLF, formatPercent)}</p>
                        </div>
                    </div>
                </div>`;
            };
            
            const createRankingListHTML = (units, title) => {
                let listHTML = `<h4 class="font-semibold text-center mb-2">${title}</h4><ul class="space-y-1 text-sm">`;
                units.forEach((d, i) => {
                    const colorClass = title.includes('Melhores') ? 'text-green-400' : 'text-red-400';
                    listHTML += `<li class="flex justify-between text-xs border-b border-gray-800/50 py-1"><span class="truncate">${i+1}. ${d.Clínica}</span><strong class="${colorClass}">${formatPercent(d.pct_meta)}</strong></li>`;
                });
                listHTML += `</ul>`;
                return listHTML;
            };

            const dharsonTop5 = [...dharsonData].sort((a,b) => b.pct_meta - a.pct_meta).slice(0, 5);
            const dharsonWorst5 = [...dharsonData].sort((a,b) => a.pct_meta - b.pct_meta).slice(0, 5);
            const viniciusTop5 = [...viniciusData].sort((a,b) => b.pct_meta - a.pct_meta).slice(0, 5);
            const viniciusWorst5 = [...viniciusData].sort((a,b) => a.pct_meta - b.pct_meta).slice(0, 5);

            container.innerHTML = `
                <h2 class="text-2xl font-bold text-[--text-primary] mb-4">Análise de Desempenho por Time</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-stretch">
                    ${createTeamCardHTML('Time Dharson', dharsonMetrics, dharsonMetricsLastWeek)}
                    <div class="bg-black/20 p-4 rounded-lg border-2 border-yellow-400 flex flex-col justify-center">
                         <h3 class="text-xl font-bold text-center text-yellow-300 mb-4">🏆 Veredito da IA</h3>
                         <div id="team-ai-verdict" class="text-center"></div>
                    </div>
                    ${createTeamCardHTML('Time Vinicius', viniciusMetrics, viniciusMetricsLastWeek)}
                </div>
                <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-black/20 p-4 rounded-lg">
                        <details>
                            <summary class="font-bold cursor-pointer hover:text-white">Unidades do Time Dharson (${dharsonData.length})</summary>
                            <p class="text-xs text-gray-400 mt-2">${dharsonData.map(d => d.Clínica).join(', ')}</p>
                        </details>
                        <hr class="border-t border-[--border-color] my-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>${createRankingListHTML(dharsonTop5, 'Top 5 Melhores')}</div>
                            <div>${createRankingListHTML(dharsonWorst5, 'Top 5 Piores')}</div>
                        </div>
                    </div>
                     <div class="bg-black/20 p-4 rounded-lg">
                        <details>
                            <summary class="font-bold cursor-pointer hover:text-white">Unidades do Time Vinicius (${viniciusData.length})</summary>
                             <p class="text-xs text-gray-400 mt-2">${viniciusData.map(d => d.Clínica).join(', ')}</p>
                        </details>
                        <hr class="border-t border-[--border-color] my-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>${createRankingListHTML(viniciusTop5, 'Top 5 Melhores')}</div>
                            <div>${createRankingListHTML(viniciusWorst5, 'Top 5 Piores')}</div>
                        </div>
                    </div>
                </div>
                ${unassignedUnits.length > 0 ? `
                <div class="mt-8 bg-yellow-900/50 p-4 rounded-lg border border-yellow-500/50">
                    <h3 class="font-bold text-yellow-300">⚠️ Unidades Sem Time Definido (${unassignedUnits.length})</h3>
                    <p class="text-xs text-yellow-200 mt-2">${unassignedUnits.map(d => d.Clínica).join(', ')}</p>
                </div>
                ` : ''}
            `;
            
            const aiContainer = document.getElementById('team-ai-verdict');
            aiContainer.innerHTML = `<div class="flex items-center justify-center space-x-2"><div class="w-4 h-4 rounded-full bg-yellow-400 animate-pulse"></div> <span>Analisando times...</span></div>`;
            const prompt = `Compare o desempenho de dois times. Time Dharson: Faturamento de ${formatCurrency(dharsonMetrics.faturamento)}, Ticket Médio de ${formatCurrency(dharsonMetrics.avgTKM)}, e conversão L->F de ${formatPercent(dharsonMetrics.conversaoLF)}. Time Vinicius: Faturamento de ${formatCurrency(viniciusMetrics.faturamento)}, Ticket Médio de ${formatCurrency(viniciusMetrics.avgTKM)}, e conversão L->F de ${formatPercent(viniciusMetrics.conversaoLF)}. Declare um vencedor com base no faturamento total e forneça uma breve análise (2-3 frases) sobre o ponto forte de cada time.`;
            aiContainer.innerHTML = await generateAIAnalysis(prompt);
        }

        function renderDataInconsistencyReport(data) {
            const container = document.getElementById('inconsistency-report-container');
            if (!container) return;
            const inconsistencies = [];

            data.forEach(unit => {
                if (unit.original_pct_meta_str) {
                    const originalValue = parseValue(unit.original_pct_meta_str.toString().replace('%', '')) / 100;
                    const calculatedValue = unit.pct_meta;
                    if (Math.abs(originalValue - calculatedValue) > 0.005) { // Diferença > 0.5%
                        inconsistencies.push({
                            clinic: unit.Clínica,
                            metric: '% Meta',
                            original: formatPercent(originalValue),
                            calculated: formatPercent(calculatedValue)
                        });
                    }
                }
            });

            if (inconsistencies.length === 0) {
                container.innerHTML = '<p class="text-green-400 text-center py-4">✅ Nenhuma inconsistência de cálculo encontrada na planilha.</p>';
                return;
            }

            let html = `<div class="table-container"><table class="min-w-full divide-y divide-[--border-color]"><thead class="bg-black/20"><tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-[--text-secondary] uppercase">Clínica</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-[--text-secondary] uppercase">Métrica</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-[--text-secondary] uppercase">Valor (Planilha)</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-[--text-secondary] uppercase">Valor (Calculado)</th>
            </tr></thead><tbody class="divide-y divide-[--border-color]">`;
            inconsistencies.forEach(d => {
                html += `<tr>
                    <td class="px-4 py-2 text-sm font-medium text-[--text-primary]">${d.clinic}</td>
                    <td class="px-4 py-2 text-sm text-[--text-secondary]">${d.metric}</td>
                    <td class="px-4 py-2 text-sm"><mark class="bg-red-800/50 rounded px-1 text-red-200">${d.original}</mark></td>
                    <td class="px-4 py-2 text-sm"><mark class="bg-green-800/50 rounded px-1 text-green-200">${d.calculated}</mark></td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // --- UTILITIES ---
        function updateURL(filters) {
            try {
                const params = new URLSearchParams();
                if (filters.unit && filters.unit !== 'all') params.set('unit', filters.unit);
                if (filters.performance && filters.performance !== 'all') params.set('performance', filters.performance);
                const newUrl = `${window.location.pathname}?${params.toString()}`;
                if (window.history.state?.url !== newUrl) {
                    window.history.pushState({
                        path: newUrl
                    }, '', newUrl);
                }
            } catch (e) {
                console.warn("Não foi possível atualizar a URL: a API de Histórico não está disponível neste ambiente.", e);
            }
        }

        function readURL() {
            const params = new URLSearchParams(window.location.search);
            return {
                unit: params.get('unit') || 'all',
                performance: params.get('performance') || 'all'
            };
        }
    </script>
</body>

</html>

